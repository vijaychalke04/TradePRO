<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Trade Genie PRO v3.2</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#050b18;color:#e2e8f0;font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh}
a{color:#60a5fa;text-decoration:none}a:hover{text-decoration:underline}
.login{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;gap:10px;background:radial-gradient(ellipse at 50% 30%,rgba(37,99,235,.08),transparent 70%)}
.login h2{font-size:28px;margin-bottom:4px}.login .sub{color:#64748b;font-size:13px;margin-bottom:12px}
input,select{padding:11px 14px;width:340px;border:none;border-radius:10px;background:#0f172a;color:#e5e7eb;outline:1px solid rgba(148,163,184,.15);font-size:14px}
input:focus,select:focus{outline:1.5px solid rgba(59,130,246,.7)}
button,.btn{padding:10px 22px;background:#2563eb;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:14px;transition:background .2s}
button:hover,.btn:hover{background:#1d4ed8}
.btn-purple{background:#7c3aed}.btn-purple:hover{background:#6d28d9}
.muted{color:#64748b}
.ticker-wrap{overflow:hidden;background:#0b1220;border-bottom:1px solid rgba(148,163,184,.06);white-space:nowrap;position:relative}
.ticker-inner{display:inline-flex;animation:tickerScroll 40s linear infinite}
.ticker-inner:hover{animation-play-state:paused}
.ticker-item{padding:8px 20px;display:inline-flex;gap:8px;align-items:center;font-size:12px;flex-shrink:0;border-right:1px solid rgba(148,163,184,.06)}
.ticker-item .tn{color:#94a3b8;font-weight:700}.ticker-item .tp{font-weight:800}.ticker-item .tc{font-weight:700}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.green{color:#10b981}.red{color:#ef4444}.amber{color:#f59e0b}
.top{background:#0b1220;padding:12px 20px;font-size:20px;font-weight:800;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(148,163,184,.08)}
.tabs{display:flex;gap:6px;padding:10px 14px;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(5,11,24,.9));position:sticky;top:0;z-index:20;border-bottom:1px solid rgba(148,163,184,.08);backdrop-filter:blur(12px);flex-wrap:wrap;align-items:center}
.tab{padding:8px 14px;background:#111827;border:1px solid rgba(148,163,184,.1);border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;user-select:none;white-space:nowrap;transition:all .15s}
.tab:hover{background:#1e293b}.active{background:#2563eb!important;border-color:rgba(59,130,246,.5)!important;color:white}
.toolRight{display:flex;gap:6px;align-items:center;font-size:12px;margin-left:auto}
.chk{display:flex;gap:5px;align-items:center;color:#94a3b8;padding:6px 10px;border-radius:10px;border:1px solid rgba(148,163,184,.1);background:#0f172a;cursor:pointer;font-size:11px}
.chk input[type=checkbox]{width:auto;margin:0}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;padding:14px}
.grid5{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;padding:14px}
.card{background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(11,18,32,.98));border:1px solid rgba(148,163,184,.1);padding:14px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.2);transition:border-color .3s}
.card .row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.card .title{font-size:14px;font-weight:700;color:#f1f5f9;flex:1;word-break:break-word}
.card .badges{display:flex;gap:4px;flex-wrap:wrap;flex-shrink:0}
.card .ltp{font-size:22px;font-weight:900;margin:4px 0 2px;font-family:'SF Mono',ui-monospace,monospace}
.kv{font-size:12px;color:#94a3b8;line-height:1.6;margin-top:2px}.kv b{color:#cbd5e1}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:800;letter-spacing:.05em}
.badge-buy{background:#10b981;color:#022c22}.badge-sell{background:#ef4444;color:#1c0a0a}.badge-hold{background:#475569;color:#e2e8f0}
.badge-pos{background:#059669;color:#ecfdf5}.badge-neg{background:#dc2626;color:#fef2f2}.badge-neu{background:#d97706;color:#1c1a12}.badge-na{background:#334155;color:#94a3b8}
.pill{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:800}
.pill.buy{background:#10b981;color:#022c22}.pill.sell{background:#ef4444;color:#1c0a0a}.pill.hold{background:#475569;color:#e2e8f0}
.idx-card{background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(11,18,32,.95));border:1px solid rgba(148,163,184,.08);border-radius:12px;padding:14px;transition:border-color .2s}
.idx-card:hover{border-color:rgba(148,163,184,.2)}
.idx-name{font-size:12px;font-weight:700;color:#94a3b8}.idx-ltp{font-size:20px;font-weight:900;font-family:'SF Mono',ui-monospace,monospace;margin:3px 0}
.idx-chg{font-size:12px;font-weight:700;margin:2px 0}.idx-ohlc{font-size:10px;color:#475569;margin-top:4px;line-height:1.6}.idx-ohlc span{color:#64748b}
.com-card{background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(11,18,32,.95));border:1px solid rgba(148,163,184,.08);border-radius:12px;padding:14px}
.com-icon{font-size:22px;margin-right:6px}.com-label{font-size:13px;font-weight:800;color:#f59e0b}
.com-ltp{font-size:20px;font-weight:900;font-family:'SF Mono',ui-monospace,monospace;margin:4px 0}
.global-card{background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(11,18,32,.95));border:1px solid rgba(148,163,184,.08);border-radius:12px;padding:14px}
.global-flag{font-size:20px}.global-name{font-size:12px;color:#94a3b8;font-weight:700;margin-top:2px}.global-ltp{font-size:18px;font-weight:900;font-family:'SF Mono',ui-monospace,monospace;margin:4px 0}.global-chg{font-size:12px;font-weight:700}
.pat{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;margin-top:4px;margin-right:4px}
.pat.bullish{background:rgba(16,185,129,.12);color:#6ee7b7;border:1px solid rgba(16,185,129,.2)}
.pat.bearish{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.2)}
.pat.neutral{background:rgba(148,163,184,.08);color:#94a3b8;border:1px solid rgba(148,163,184,.1)}
.news-item{padding:14px;border-bottom:1px solid rgba(148,163,184,.06)}.news-item:hover{background:rgba(30,41,59,.3)}
.news-title{font-size:14px;font-weight:600;color:#f1f5f9;margin-bottom:4px}
.news-meta{font-size:11px;color:#64748b;display:flex;gap:8px;margin-bottom:4px}.news-desc{font-size:12px;color:#94a3b8;line-height:1.5}
.bt-warn{padding:10px;border-radius:8px;font-size:13px;line-height:1.6;margin-top:8px}
.bt-warn.neg{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#fca5a5}
.bt-warn.pos{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:#6ee7b7}
.bt-warn.amb{background:rgba(217,119,6,.06);border:1px solid rgba(217,119,6,.2);color:#fbbf24}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(148,163,184,.2);border-top-color:#60a5fa;border-radius:50%;animation:spin .5s linear infinite;vertical-align:middle;margin-left:4px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulseGood{0%,100%{box-shadow:0 0 0 rgba(16,185,129,0)}50%{box-shadow:0 0 16px rgba(16,185,129,.15);border-color:rgba(16,185,129,.5)}}
@keyframes pulseBad{0%,100%{box-shadow:0 0 0 rgba(239,68,68,0)}50%{box-shadow:0 0 16px rgba(239,68,68,.15);border-color:rgba(239,68,68,.5)}}
.pulse-good{animation:pulseGood 2s ease-in-out infinite}.pulse-bad{animation:pulseBad 2s ease-in-out infinite}
.sec{padding:14px}.sec-label{font-size:11px;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:#475569;margin-bottom:10px;padding:0 4px}
.mono{font-family:'SF Mono',ui-monospace,monospace}
.wl-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(148,163,184,.06);gap:10px;flex-wrap:wrap}.wl-row:hover{background:rgba(30,41,59,.3)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* SMART ALERTS v2 ‚Äî WhatsApp-style       */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.sa-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.sa-filter{padding:6px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.15);background:#0f172a;color:#94a3b8;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;user-select:none}
.sa-filter:hover{background:#1e293b;color:#e2e8f0}
.sa-filter.on{background:#2563eb;border-color:rgba(59,130,246,.5);color:white}
.sa-filter.on-ready{background:#059669;border-color:rgba(5,150,105,.5);color:white}
.sa-filter.on-warn{background:#d97706;border-color:rgba(217,119,6,.5);color:white}
.sa-search{padding:8px 14px;border-radius:10px;background:#0f172a;border:1px solid rgba(148,163,184,.12);color:#e2e8f0;font-size:13px;outline:none;width:200px;flex-shrink:0}
.sa-search:focus{border-color:rgba(59,130,246,.5)}
.sa-search::placeholder{color:#475569}
.sa-count{font-size:11px;color:#475569;margin-left:auto;white-space:nowrap}
.sa-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px}
.sa-card{border-radius:14px;padding:16px;border:1px solid rgba(148,163,184,.1);background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(11,18,32,.98));box-shadow:0 4px 20px rgba(0,0,0,.15);transition:all .3s}
.sa-card.ready{border-color:rgba(16,185,129,.4);animation:pulseGood 2.5s ease-in-out infinite}
.sa-card.confirming{border-color:rgba(250,204,21,.3)}
.sa-card.warning{border-color:rgba(245,158,11,.25);background:linear-gradient(180deg,rgba(30,20,10,.6),rgba(11,18,32,.98))}
.sa-header{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px}
.sa-name{font-size:16px;font-weight:900;color:#f1f5f9;line-height:1.2}
.sa-type{font-size:10px;color:#94a3b8;font-weight:600;margin-top:2px}
.sa-tags{display:flex;gap:5px;flex-shrink:0;flex-wrap:wrap}
.sa-tag{padding:3px 10px;border-radius:999px;font-size:10px;font-weight:800;letter-spacing:.03em}
.sa-tag.t-ready{background:rgba(16,185,129,.15);color:#6ee7b7;border:1px solid rgba(16,185,129,.3)}
.sa-tag.t-confirming{background:rgba(250,204,21,.12);color:#fde68a;border:1px solid rgba(250,204,21,.3)}
.sa-tag.t-watch{background:rgba(59,130,246,.12);color:#93c5fd;border:1px solid rgba(59,130,246,.3)}
.sa-tag.t-warning{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.3)}
.sa-tag.t-seg{background:rgba(148,163,184,.08);color:#94a3b8;border:1px solid rgba(148,163,184,.1)}
.sa-action{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px;margin:10px 0}
.sa-action-text{font-size:14px;font-weight:700;color:#f1f5f9;line-height:1.5}
.sa-action-text .ce{color:#10b981;font-weight:900}.sa-action-text .pe{color:#ef4444;font-weight:900}
.sa-option-hint{font-size:11px;color:#64748b;margin-top:4px}
.sa-levels{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px}
.sa-lv{text-align:center;padding:6px 4px;border-radius:8px;background:rgba(255,255,255,.03)}
.sa-lv-label{font-size:9px;color:#475569;font-weight:700;text-transform:uppercase;letter-spacing:.1em}
.sa-lv-val{font-size:13px;font-weight:900;color:#cbd5e1;margin-top:2px;font-family:'SF Mono',ui-monospace,monospace}
.sa-oneliner{margin-top:10px;padding:8px 12px;border-radius:8px;background:rgba(37,99,235,.06);border:1px solid rgba(59,130,246,.15);font-size:12px;font-weight:700;color:#93c5fd;font-family:'SF Mono',ui-monospace,monospace;line-height:1.5;word-break:break-word}
.sa-card.warning .sa-oneliner{background:rgba(245,158,11,.06);border-color:rgba(245,158,11,.15);color:#fbbf24}
.sa-card.ready .sa-oneliner{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.2);color:#6ee7b7}
.sa-progress{height:6px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;margin-top:10px}
.sa-progress > div{height:100%;border-radius:999px;transition:width .5s}
.sa-progress.p-watch > div{background:rgba(59,130,246,.6)}
.sa-progress.p-confirming > div{background:rgba(250,204,21,.7)}
.sa-progress.p-ready > div{background:rgba(16,185,129,.8)}
.sa-msg{font-size:12px;color:#94a3b8;margin-top:8px;line-height:1.5}
.sa-conf{font-size:11px;color:#475569;margin-top:6px}

/* Context Menu */
.ctx-menu{position:fixed;z-index:9999;background:#1e293b;border:1px solid #334155;border-radius:10px;padding:4px 0;min-width:180px;box-shadow:0 8px 30px rgba(0,0,0,.6);animation:ctxIn .15s ease}
@keyframes ctxIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.ctx-item{padding:10px 16px;font-size:13px;color:#e2e8f0;cursor:pointer;display:flex;gap:8px;align-items:center}
.ctx-item:hover{background:rgba(59,130,246,.15);color:#60a5fa}
.ctx-sep{height:1px;background:#334155;margin:4px 0}

/* Notification Toast */
.notif-toast{position:fixed;top:16px;right:16px;z-index:10000;background:linear-gradient(135deg,#065f46,#064e3b);border:1px solid #10b981;border-radius:12px;padding:14px 20px;max-width:380px;box-shadow:0 8px 30px rgba(0,0,0,.5);animation:slideIn .3s ease;cursor:pointer}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.notif-toast .nt-title{font-weight:800;color:#34d399;font-size:14px;margin-bottom:4px}
.notif-toast .nt-body{color:#a7f3d0;font-size:12px;line-height:1.4}
.notif-toast.nt-exit{animation:slideOut .3s ease forwards}
@keyframes slideOut{to{transform:translateX(120%);opacity:0}}

/* Greeks Calculator */
.greek-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
.greek-input{display:flex;flex-direction:column;gap:3px}
.greek-input label{font-size:11px;color:#94a3b8;font-weight:600}
.greek-input input,.greek-input select{padding:8px 10px;background:#0f172a;border:1px solid #334155;color:#f1f5f9;border-radius:8px;font-size:13px}
.greek-result{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.greek-val{text-align:center;padding:10px;background:#0f172a;border-radius:8px;border:1px solid #1e293b}
.greek-val .gk-label{font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:1px}
.greek-val .gk-num{font-size:20px;font-weight:800;margin-top:2px}
</style>
</head>
<body>
<!-- Context Menu (hidden by default) -->
<div id="ctxMenu" class="ctx-menu" style="display:none">
  <div class="ctx-item" onclick="ctxAddWatchlist()">‚≠ê Add to Watchlist</div>
  <div class="ctx-item" onclick="ctxRemoveWatchlist()">‚ùå Remove from Watchlist</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxBacktest()">üìä Backtest This Stock</div>
  <div class="ctx-item" onclick="ctx52Week()">üìÖ 52-Week Analysis</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxGreeks()">üßÆ Greeks Calculator</div>
</div>
<!-- Notification Container -->
<div id="notifArea" style="position:fixed;top:16px;right:16px;z-index:10000;display:flex;flex-direction:column;gap:8px"></div>
<div id="loginScreen" class="login">
  <h2>üßû Trade Genie PRO</h2>
  <div class="sub">Institutional-Grade Personal Trading Engine v3.2</div>
  <input id="backend" placeholder="Render Backend URL" value="https://tradepro-5hpz.onrender.com">
  <input id="mpin" type="password" placeholder="Angel MPIN" autocomplete="off">
  <input id="totp" placeholder="TOTP Code" autocomplete="off">
  <button onclick="doLogin()">Login</button>
  <p id="status" class="muted" style="margin-top:4px;font-size:13px"></p>
</div>
<div id="app" style="display:none">
  <div id="tickerWrap" class="ticker-wrap"><div id="tickerInner" class="ticker-inner"></div></div>
  <div class="top"><div>üßû Trade Genie PRO</div><div id="mktStatus" class="mono" style="font-size:13px">‚Äî</div></div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('dashboard',this)">Dashboard</div>
    <div class="tab" onclick="switchTab('trade',this)">Trades</div>
    <div class="tab" onclick="switchTab('discover',this)">üîç Discover</div>
    <div class="tab" onclick="switchTab('watchlist',this)">‚≠ê Watchlist</div>
    <div class="tab" onclick="switchTab('stocks',this)">Stocks</div>
    <div class="tab" onclick="switchTab('commodities',this)">Commodities</div>
    <div class="tab" onclick="switchTab('global',this)">üåç Global</div>
    <div class="tab" onclick="switchTab('news',this)">üì∞ News</div>
    <div class="tab" onclick="switchTab('backtest',this)">Backtesting</div>
    <div class="tab" onclick="switchTab('journal',this)">Journal</div>
    <div class="toolRight">
      <label class="chk"><input type="checkbox" id="showHold" checked onchange="toggleHold()"> HOLD</label>
      <div class="tab" onclick="manualRefresh()">üîÑ Refresh</div>
      <div class="tab" onclick="doLogout()">Logout</div>
    </div>
  </div>
  <div id="dashboard"></div>
  <div id="trade" class="grid" style="display:none"></div>

  <!-- DISCOVER TAB -->
  <div id="discover" style="display:none;padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="font-size:16px;margin:0">üîç Stock Discovery ‚Äî Automated Picks</h3>
      <button onclick="runScreener()" style="padding:8px 18px;background:#7c3aed;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:13px">üîÑ Scan All Stocks</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <button onclick="showDiscoverSection('invest')" id="discBtn1" class="disc-btn disc-active" style="padding:8px 16px;border-radius:8px;border:1px solid #334155;background:#1e293b;color:#f1f5f9;cursor:pointer;font-weight:600;font-size:13px">üìà Long-Term Investment</button>
      <button onclick="showDiscoverSection('fno')" id="discBtn2" class="disc-btn" style="padding:8px 16px;border-radius:8px;border:1px solid #334155;background:transparent;color:#94a3b8;cursor:pointer;font-weight:600;font-size:13px">‚ö° F&O / Options Trading</button>
    </div>
    <div id="discoverInvest"></div>
    <div id="discoverFnO" style="display:none"></div>
  </div>

  <!-- WATCHLIST TAB -->
  <div id="watchlist" style="display:none;padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="font-size:16px;margin:0">‚≠ê My Watchlist</h3>
      <button onclick="refreshWatchlist()" style="padding:8px 18px;background:#0ea5e9;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:13px">üîÑ Refresh Prices</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:14px;align-items:center">
      <input id="wlAddInput" placeholder="Type stock name (e.g. RELIANCE)..." style="flex:1;min-width:200px" onkeyup="if(event.key==='Enter')addToWatchlist()">
      <button onclick="addToWatchlist()" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700">+ Add</button>
    </div>
    <div id="wlGrid" class="grid"></div>
    <div id="wlEmpty" class="card muted" style="text-align:center;padding:30px">Your watchlist is empty. Add stocks above to start tracking.</div>
  </div>

  <div id="stocks" class="grid" style="display:none"></div>
  <div id="commodities" style="display:none"></div>
  <div id="global" style="display:none"></div>
  <div id="news" style="display:none"></div>
  <div id="backtest" style="display:none;padding:14px">
    <h3 style="font-size:16px;margin-bottom:12px">üìä Backtest & Analysis Engine</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
      <input id="searchStock" placeholder="Search stock..." style="flex:1;min-width:180px" onkeyup="filterStocks()">
      <select id="stockList" style="min-width:180px"></select>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
      <button onclick="runBacktest()" title="EMA 9/21 crossover on 15-min candles (30 days)">üìà EMA Backtest</button>
      <button class="btn-purple" onclick="run52Week()" title="52-week high/low analysis with bounce + momentum hybrid strategy" style="padding:10px 22px;background:#7c3aed;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:14px">üìÖ 52-Week Analysis</button>
      <button class="btn-purple" onclick="runMC()" title="Monte Carlo simulation for probability estimation" style="padding:10px 22px;background:#7c3aed;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:14px">üé≤ Monte Carlo</button>
    </div>
    <div id="w52Out"></div><div id="mcOut"></div><div id="btResult"></div>

    <!-- Greeks Calculator -->
    <div style="margin-top:20px;border-top:1px solid #1e293b;padding-top:16px">
      <h3 style="font-size:15px;margin-bottom:12px">üßÆ Options Greeks Calculator (Black-Scholes)</h3>
      <div class="greek-grid">
        <div class="greek-input"><label>Spot Price (‚Çπ)</label><input id="gkSpot" type="number" value="22000" step="10"></div>
        <div class="greek-input"><label>Strike Price (‚Çπ)</label><input id="gkStrike" type="number" value="22000" step="50"></div>
        <div class="greek-input"><label>Days to Expiry</label><input id="gkDays" type="number" value="7" min="1" max="365"></div>
        <div class="greek-input"><label>IV (%)</label><input id="gkIV" type="number" value="15" step="0.5" min="1" max="200"></div>
        <div class="greek-input"><label>Risk-Free Rate (%)</label><input id="gkRate" type="number" value="7" step="0.5"></div>
        <div class="greek-input"><label>Option Type</label><select id="gkType"><option value="CE">CE (Call)</option><option value="PE">PE (Put)</option></select></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button onclick="calcGreeks()" style="padding:10px 22px;background:#0ea5e9;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:14px">Calculate Greeks</button>
        <button onclick="fillGreeksFromStock()" style="padding:10px 16px;background:transparent;border:1px solid #334155;color:#94a3b8;border-radius:10px;cursor:pointer;font-size:12px">üìà Use Selected Stock LTP</button>
        <span class="muted" style="font-size:11px">Theoretical premium & Greeks via Black-Scholes model</span>
      </div>
      <div id="greeksResult"></div>
    </div>
  </div>
  <div id="journal" style="display:none;padding:14px"><div class="sec-label">Trade Journal</div><div id="journalGrid" class="grid"></div></div>
</div>
<script>
let C={indices:[],stocks:[],commodities:[],watchlist:[],alerts:[],_meta:{}},SHOW_HOLD=true,pollTimer=null,mktTimer=null,sseConn=null;
let WARMUP_FE={cycles:0,firstFetch:0};
let JOURNAL=[];try{JOURNAL=JSON.parse(localStorage.getItem("TG32_JOURNAL")||"[]")}catch(e){JOURNAL=[]}
const STOCK_LIST=["ADANIENT","ADANIPORTS","APOLLOHOSP","ASIANPAINT","AXISBANK","BAJAJ-AUTO","BAJFINANCE","BAJAJFINSV","BPCL","BHARTIARTL","BRITANNIA","CIPLA","COALINDIA","DIVISLAB","DRREDDY","EICHERMOT","GRASIM","HCLTECH","HDFCBANK","HDFCLIFE","HEROMOTOCO","HINDALCO","HINDUNILVR","ICICIBANK","ITC","INDUSINDBK","INFY","JSWSTEEL","KOTAKBANK","LT","M&M","MARUTI","NESTLEIND","NTPC","ONGC","POWERGRID","RELIANCE","SBILIFE","SBIN","SUNPHARMA","TCS","TATACONSUM","TATAMOTORS","TATASTEEL","TECHM","TITAN","ULTRACEMCO","UPL","WIPRO","BANKBARODA","BEL","BHEL","BIOCON","CANBK","CHOLAFIN","DLF","ESCORTS","FEDERALBNK","GAIL","GODREJCP","HAL","HAVELLS","IDFCFIRSTB","INDHOTEL","IOC","IRCTC","JINDALSTEL","LICHSGFIN","LUPIN","MRF","MUTHOOTFIN","NAUKRI","OBEROIRLTY","PAGEIND","PERSISTENT","PIDILITIND","PNB","POLYCAB","RECLTD","SAIL","SHRIRAMFIN","SIEMENS","SRF","TATAPOWER","TORNTPHARM","TRENT","VEDL","VOLTAS","ZOMATO"];
// Watchlist persistence
let MY_WATCHLIST=[];try{MY_WATCHLIST=JSON.parse(localStorage.getItem("TG32_WATCHLIST")||"[]")}catch(e){MY_WATCHLIST=[]}
const COM_ICONS={"CRUDEOIL":"üõ¢Ô∏è","CRUDE":"üõ¢Ô∏è","NATURALGAS":"üî•","NATGAS":"üî•","GOLD":"ü™ô","GOLDM":"ü™ô","SILVER":"ü•à","SILVERM":"ü•à","COPPER":"üü§"};
let SA_FILTER="ALL",SA_SEARCH="";

function esc(s){const d=document.createElement("div");d.textContent=s;return d.innerHTML}
function fN(v,d){d=d||2;const n=+v;return isFinite(n)?n.toLocaleString("en-IN",{minimumFractionDigits:d,maximumFractionDigits:d}):"‚Äî"}
function fP(v){const n=+v;return isFinite(n)?n.toFixed(2):"‚Äî"}
function fmt(v){if(v==null||v==="")return"‚Äî";if(typeof v==="object"){if(v.suggested)return String(v.suggested);if(v.strike)return v.strike+" "+(v.optionType||"");return"‚Äî"}return String(v)}
function sigBadge(s){s=(s||"HOLD").toUpperCase();return s==="BUY"?'<span class="badge badge-buy">BUY</span>':s==="SELL"?'<span class="badge badge-sell">SELL</span>':'<span class="badge badge-hold">HOLD</span>'}
function edgeBadge(e){e=(e||"NA").toUpperCase();if(e.includes("POS"))return'<span class="badge badge-pos">POSITIVE</span>';if(e.includes("NEG"))return'<span class="badge badge-neg">NEGATIVE</span>';if(e.includes("NEU"))return'<span class="badge badge-neu">NEUTRAL</span>';return'<span class="badge badge-na">'+e+'</span>'}
function chgClass(v){return(+v||0)>=0?"green":"red"}
function arrow(v){return(+v||0)>=0?"‚ñ≤":"‚ñº"}
function patHTML(pats){if(!pats||!pats.length)return"";return pats.map(p=>'<span class="pat '+(p.sentiment==="Bullish"?"bullish":p.sentiment==="Bearish"?"bearish":"neutral")+'">'+esc(p.name)+'</span>').join("")}
function fmtSym(n){n=String(n||"").replace(/-EQ$/i,"").trim();const m=n.match(/^([A-Z]+?)(\d{1,2}[A-Z]{3}\d{2})(\d+)(CE|PE)$/i);if(m)return m[1]+" "+m[2]+" "+m[3]+" "+m[4];const m2=n.match(/^([A-Z]+?)(\d{1,2}[A-Z]{3}\d{2,4})(FUT)$/i);if(m2)return m2[1]+" "+m2[2]+" "+m2[3];return n}
function prettySym(n){return fmtSym(n).replace(/Nifty Fin Servi ce/i,"FINNIFTY").replace(/Nifty 50/i,"NIFTY 50").replace(/Nifty Bank/i,"BANKNIFTY").replace(/India VIX/i,"INDIA VIX")}
function comIcon(label){for(const k of Object.keys(COM_ICONS)){if(String(label||"").toUpperCase().includes(k))return COM_ICONS[k]}return"üìä"}
function clampNum(n,a,b){n=Number(n);if(!isFinite(n))n=0;return Math.max(a,Math.min(b,n))}

function getIST(){const n=new Date();return new Date(n.getTime()+n.getTimezoneOffset()*60000+5.5*3600000)}
function updateMktStatus(){const ist=getIST(),d=ist.getDay(),m=ist.getHours()*60+ist.getMinutes(),el=document.getElementById("mktStatus");if(!el)return;if(d===0||d===6){el.innerHTML='üî¥ <span class="red">WEEKEND CLOSED</span>';return}if(m>=555&&m<930)el.innerHTML='üü¢ <span class="green">EQUITY LIVE</span> ¬∑ <span class="green">MCX LIVE</span>';else if(m>=930&&m<935)el.innerHTML='üü° <span class="amber">EQUITY CLOSING</span> ¬∑ <span class="green">MCX LIVE</span>';else if(m>=935&&m<1410)el.innerHTML='üî¥ <span class="red">EQUITY CLOSED</span> ¬∑ <span class="green">MCX LIVE</span>';else if(m>=540&&m<555)el.innerHTML='üü° <span class="amber">PRE-OPEN</span>';else el.innerHTML='üî¥ <span class="red">MARKET CLOSED</span>'}
function isEquityHours(){const ist=getIST(),d=ist.getDay(),m=ist.getHours()*60+ist.getMinutes();return d>0&&d<6&&m>=555&&m<935}
function isMcxHours(){const ist=getIST(),d=ist.getDay(),m=ist.getHours()*60+ist.getMinutes();return d>0&&d<6&&m>=540&&m<1410}
function isAnyMarketOpen(){return isEquityHours()||isMcxHours()}

let tickerData=[];
function renderTicker(){const el=document.getElementById("tickerInner");if(!el)return;const all=[].concat(C.indices||[]);if(!all.length&&!tickerData.length){el.innerHTML="";return}if(all.length)tickerData=all;const items=tickerData.map(x=>{const c=chgClass(x.changePct);return'<div class="ticker-item" data-token="'+esc(String(x.token||""))+'"><span class="tn">'+esc(prettySym(x.name))+'</span><span class="tp '+c+'" data-field="ltp">'+fP(x.ltp)+'</span><span class="tc '+c+'" data-field="chg">'+arrow(x.changePct)+fP(Math.abs(x.change||0))+' ('+fP(Math.abs(x.changePct||0))+'%)</span></div>'});el.innerHTML=items.join("")+items.join("")}
function updateTickerPrice(token,ltp,change,changePct){document.querySelectorAll('.ticker-item[data-token="'+token+'"]').forEach(el=>{const pEl=el.querySelector('[data-field="ltp"]'),cEl=el.querySelector('[data-field="chg"]');const c=chgClass(changePct);if(pEl){pEl.textContent=fP(ltp);pEl.className="tp "+c}if(cEl){cEl.textContent=arrow(changePct)+fP(Math.abs(change||0))+" ("+fP(Math.abs(changePct||0))+"%)";cEl.className="tc "+c}})}

async function doLogin(){const backend=document.getElementById("backend").value.trim().replace(/\/+$/,""),mpin=document.getElementById("mpin").value,totp=document.getElementById("totp").value,st=document.getElementById("status");st.innerHTML='Logging in...<span class="spinner"></span>';try{const r=await fetch(backend+"/api/angel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"login",mpin,totp})});const j=await r.json().catch(()=>null);if(j?.ok){sessionStorage.setItem("B",backend);sessionStorage.setItem("T",j.token);document.getElementById("loginScreen").style.display="none";document.getElementById("app").style.display="block";updateMktStatus();startPolling();connectSSE();await fetchData();fetchGlobalData();fetchNewsData();st.innerText=""}else st.innerText="Failed: "+(j?.error||"Unknown")}catch(e){st.innerText="Error: "+e.message}}
async function doLogout(){try{const b=sessionStorage.getItem("B"),t=sessionStorage.getItem("T");if(b)await fetch(b+"/api/angel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"logout",token:t})}).catch(()=>{})}catch(e){}stopPolling();if(sseConn){sseConn.close();sseConn=null}sessionStorage.clear();document.getElementById("app").style.display="none";document.getElementById("loginScreen").style.display="flex"}
function startPolling(){stopPolling();const ms=isAnyMarketOpen()?5000:30000;pollTimer=setInterval(fetchData,ms);mktTimer=setInterval(()=>{updateMktStatus();const ms2=isAnyMarketOpen()?5000:30000;clearInterval(pollTimer);pollTimer=setInterval(fetchData,ms2)},30000)}
function stopPolling(){if(pollTimer)clearInterval(pollTimer);if(mktTimer)clearInterval(mktTimer)}
function manualRefresh(){fetchData();fetchGlobalData();fetchNewsData()}

function connectSSE(){const b=sessionStorage.getItem("B");if(!b)return;try{sseConn=new EventSource(b+"/api/stream");sseConn.addEventListener("tick",e=>{try{const d=JSON.parse(e.data);if(d.token&&isFinite(d.ltp))handleTick(d)}catch(e){}});sseConn.onerror=()=>{}}catch(e){}}
function handleTick(tick){const all=[].concat(C.indices||[],C.stocks||[],C.commodities||[]);const item=all.find(x=>String(x.token)===String(tick.token));if(item){item.ltp=tick.ltp;if(tick.open)item.open=tick.open;if(tick.high)item.high=tick.high;if(tick.low)item.low=tick.low;if(tick.close)item.close=tick.close;const cl=item.close||tick.close||item.ltp;item.change=+(tick.ltp-cl).toFixed(2);item.changePct=cl?+((tick.ltp-cl)/cl*100).toFixed(2):0;updateTickerPrice(String(tick.token),tick.ltp,item.change,item.changePct);const el=document.querySelector('[data-token="'+tick.token+'"] .ltp');if(el)el.textContent="‚Çπ "+fP(tick.ltp)}}

function switchTab(id,el){document.querySelectorAll(".tabs .tab").forEach(x=>x.classList.remove("active"));if(el)el.classList.add("active");["dashboard","trade","discover","watchlist","stocks","commodities","global","news","backtest","journal"].forEach(t=>{const n=document.getElementById(t);if(n)n.style.display="none"});const s=document.getElementById(id);if(!s)return;s.style.display=(id==="trade"||id==="stocks"||id==="wlGrid")?"grid":"block";if(id==="global")fetchGlobalData();if(id==="news")fetchNewsData();if(id==="discover"&&!document.getElementById("discoverInvest").innerHTML)runScreener();if(id==="watchlist"){renderWatchlist();if(MY_WATCHLIST.length)refreshWatchlist();startWLAutoRefresh()}else{stopWLAutoRefresh()}}
function toggleHold(){SHOW_HOLD=!!document.getElementById("showHold")?.checked;render()}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* SMART ALERTS v2 ‚Äî WhatsApp-style cards     */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saFilterClick(cat,el){SA_FILTER=cat;document.querySelectorAll('.sa-filter').forEach(x=>{x.className='sa-filter'});if(el){let cls='sa-filter on';if(cat==='READY')cls='sa-filter on-ready';else if(cat==='WARNING')cls='sa-filter on-warn';el.className=cls}renderAlerts()}
function saSearchInput(val){SA_SEARCH=(val||"").toLowerCase();renderAlerts()}

function getFilteredAlerts(){
  let al=(C.alerts||[]);
  if(SA_FILTER!=="ALL"){al=al.filter(a=>{const cat=(a.category||"").toUpperCase(),st=(a.status||"").toUpperCase();if(SA_FILTER==="READY")return cat==="READY"||st==="READY";if(SA_FILTER==="WATCH")return cat==="WATCH"||st==="WATCH"||st==="CONFIRMING";if(SA_FILTER==="WARNING")return cat==="WARNING"||st==="WARNING";return true})}
  if(SA_SEARCH){al=al.filter(a=>String(a.name||"").toLowerCase().includes(SA_SEARCH)||String(a.segment||"").toLowerCase().includes(SA_SEARCH)||String(a.type||"").toLowerCase().includes(SA_SEARCH))}
  return al;
}

function buildSACard(a){
  if(!a)return"";
  const name=prettySym(a.name||"");
  const st=(a.status||"WATCH").toUpperCase();
  const cat=(a.category||"WATCH").toUpperCase();
  const isWarning=cat==="WARNING";
  const isReady=st==="READY";
  const isConfirming=st==="CONFIRMING";
  const cardCls="sa-card"+(isReady?" ready":isConfirming?" confirming":isWarning?" warning":"");
  let tagCls="sa-tag ",tagText="";
  if(isReady){tagCls+="t-ready";tagText="‚úÖ READY"}else if(isConfirming){tagCls+="t-confirming";tagText="‚è≥ CONFIRMING"}else if(isWarning){tagCls+="t-warning";tagText="‚ö†Ô∏è WARNING"}else{tagCls+="t-watch";tagText="üëÄ WATCH"}
  const typeEmoji={"BREAKOUT":"üìà","DIP_BUY":"üîÑ","FALL":"üìâ","TRAP":"ü™§","BIG_MOVE":"‚ö°"}[a.type]||"üìä";
  let actionHTML=esc(a.action||"Watch");
  actionHTML=actionHTML.replace(/\b(CE|CALL)\b/g,'<span class="ce">$1</span>').replace(/\b(PE|PUT)\b/g,'<span class="pe">$1</span>');
  let levelsHTML="";
  if(a.trigger||a.sl||a.t1){levelsHTML='<div class="sa-levels">';if(a.trigger!=null)levelsHTML+='<div class="sa-lv"><div class="sa-lv-label">Trigger</div><div class="sa-lv-val">‚Çπ'+fN(a.trigger)+'</div></div>';if(a.sl!=null)levelsHTML+='<div class="sa-lv"><div class="sa-lv-label">Stop Loss</div><div class="sa-lv-val red">‚Çπ'+fN(a.sl)+'</div></div>';if(a.t1!=null)levelsHTML+='<div class="sa-lv"><div class="sa-lv-label">Target 1</div><div class="sa-lv-val green">‚Çπ'+fN(a.t1)+'</div></div>';if(a.t2!=null)levelsHTML+='<div class="sa-lv"><div class="sa-lv-label">Target 2</div><div class="sa-lv-val green">‚Çπ'+fN(a.t2)+'</div></div>';levelsHTML+='</div>'}
  let progressHTML="";
  if(!isWarning&&a.trigger!=null){const prog=clampNum(a.progress||0,0,100);const pCls="sa-progress p-"+(isReady?"ready":isConfirming?"confirming":"watch");progressHTML='<div class="'+pCls+'"><div style="width:'+prog+'%"></div></div>'}
  const saStockName=(a.name||"").replace(/-EQ$/,"").replace(/^(NIFTY\s*50|NIFTY BANK|SENSEX)$/i,m=>m).trim();
  return'<div class="'+cardCls+'" data-stockname="'+esc(saStockName)+'"><div class="sa-header"><div><div class="sa-name">'+typeEmoji+' '+esc(name)+'</div><div class="sa-type">'+esc(a.label||a.type||"Alert")+'</div></div><div class="sa-tags"><span class="sa-tag t-seg">'+esc(a.segment||"")+'</span><span class="'+tagCls+'">'+tagText+'</span></div></div><div class="sa-action"><div class="sa-action-text">'+actionHTML+'</div>'+(a.optionHint?'<div class="sa-option-hint">'+esc(a.optionHint)+'</div>':"")+'</div>'+levelsHTML+(a.oneLiner?'<div class="sa-oneliner">'+esc(a.oneLiner)+'</div>':"")+progressHTML+(a.message?'<div class="sa-msg">'+esc(a.message)+'</div>':'')+'<div class="sa-conf">Confidence: <b>'+esc(a.confidence||"‚Äî")+'</b> ¬∑ Strength: <b>'+(a.strength||0)+'</b>/100</div></div>';
}

function renderAlerts(){
  const container=document.getElementById("saContainer");if(!container)return;
  const al=getFilteredAlerts();
  const countEl=document.getElementById("saCount");if(countEl)countEl.textContent=al.length+" alert"+(al.length!==1?"s":"");
  if(!al.length){
    const cycleN=WARMUP_FE.cycles||0;
    if(cycleN<=2){
      container.innerHTML='<div class="card" style="border-color:rgba(59,130,246,.3)"><div style="display:flex;align-items:center;gap:8px"><span class="spinner"></span><div><div style="font-weight:700">Building market picture‚Ä¶</div><div class="muted" style="font-size:11px;margin-top:4px">Gathering candle data and computing indicators. Alerts will appear in 10‚Äì20 seconds.</div></div></div></div>';
    } else {
      // Show top movers with directional hint
      const allItems=[].concat(C.indices||[],C.stocks||[],C.commodities||[]).filter(x=>x.ltp>0);
      const movers=allItems.slice().sort((a,b)=>Math.abs(b.changePct||0)-Math.abs(a.changePct||0)).slice(0,3);
      let fallH='<div class="card" style="border-color:rgba(245,158,11,.15)"><div style="font-weight:700;color:#f59e0b;margin-bottom:6px">üëÄ No high-confidence setups yet</div><div class="muted" style="font-size:12px;margin-bottom:8px">The engine needs a clear trend + confirmation to generate alerts. Here\'s what\'s moving:</div>';
      movers.forEach(x=>{const c=chgClass(x.changePct);const sc=x.engine?.score||50;fallH+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px solid rgba(148,163,184,.06)"><div><b>'+esc(prettySym(x.name))+'</b> <span class="'+c+'">'+arrow(x.changePct)+fP(Math.abs(x.changePct))+'%</span></div><div class="muted" style="font-size:11px">Score: '+Math.round(sc)+'</div></div>'});
      fallH+='<div class="muted" style="font-size:11px;margin-top:8px">Engine is scanning continuously. Alerts auto-appear when setups are found.</div></div>';
      container.innerHTML=fallH;
    }
    return;
  }
  container.innerHTML=al.map(a=>buildSACard(a)).join("");
}

function buildCard(item,showPatterns){const nm=item.name||"‚Äî",ltp=item.ltp,eng=item.engine||{},sig=(eng.signal||"HOLD").toUpperCase();if(!SHOW_HOLD&&sig==="HOLD")return"";const edge=(eng.edge||"NA").toUpperCase();const pulse=sig==="BUY"?"pulse-good":sig==="SELL"?"pulse-bad":"";let opt=fmt(eng.optionSuggestion);const tgt=eng.projectedTarget,sl=eng.stopLoss;let patsH="";if(showPatterns&&eng.patterns?.length)patsH='<div style="margin-top:4px">'+patHTML(eng.patterns)+'</div>';const cleanName=prettySym(nm).replace(/-EQ$/,"").trim();return'<div class="card '+pulse+'" data-token="'+esc(String(item.token||""))+'" data-stockname="'+esc(cleanName)+'"><div class="row"><div class="title">'+esc(prettySym(nm))+'</div><div class="badges">'+sigBadge(sig)+edgeBadge(edge)+'</div></div>'+(isFinite(+ltp)?'<div class="ltp">‚Çπ '+fP(ltp)+'</div>':'')+'<div class="kv">Mode: <b>'+fmt(eng.mode)+'</b> &nbsp; Trade: <b>'+esc(prettySym(fmt(eng.trade)))+'</b></div><div class="kv">Option: <b>'+esc(fmtSym(opt))+'</b></div><div class="kv">Target: <b>'+(tgt!=null?fP(tgt):"‚Äî")+'</b> | SL: <b>'+(sl!=null?fP(sl):"‚Äî")+'</b></div>'+(eng.reason?'<div class="kv muted" style="font-size:11px;font-style:italic">'+esc(String(eng.reason))+'</div>':'')+patsH+'</div>'}

const _jSeen={};
function logJ(item,sig,trade,opt,tgt,sl){if(sig==="HOLD")return;const key=String(item.token||item.name)+"_"+sig+"_"+String(opt||"");const now=Date.now();if(_jSeen[key]&&now-_jSeen[key]<300000)return;_jSeen[key]=now;JOURNAL.push({time:getIST().toLocaleString("en-IN"),symbol:item.name||"?",signal:sig,trade:fmtSym(trade),option:fmtSym(opt),ltp:item.ltp,target:tgt,sl});if(JOURNAL.length>80)JOURNAL=JOURNAL.slice(-50);try{localStorage.setItem("TG32_JOURNAL",JSON.stringify(JOURNAL))}catch(e){}}

function render(){
  const dashEl=document.getElementById("dashboard"),tradeEl=document.getElementById("trade"),stocksEl=document.getElementById("stocks"),comEl=document.getElementById("commodities");
  renderTicker();
  if(dashEl){let h='';
    const al=(C.alerts||[]),readyN=al.filter(a=>(a.category||"").toUpperCase()==="READY"||(a.status||"").toUpperCase()==="READY").length,watchN=al.filter(a=>{const c=(a.category||"").toUpperCase(),s=(a.status||"").toUpperCase();return c==="WATCH"||s==="WATCH"||s==="CONFIRMING"}).length,warnN=al.filter(a=>(a.category||"").toUpperCase()==="WARNING").length;
    h+='<div class="sec"><div class="sec-label">üîî Smart Alerts</div>';
    h+='<div class="sa-toolbar">';
    h+='<div class="sa-filter'+(SA_FILTER==="ALL"?" on":"")+'" onclick="saFilterClick(\'ALL\',this)">All ('+al.length+')</div>';
    h+='<div class="sa-filter'+(SA_FILTER==="READY"?" on-ready":"")+'" onclick="saFilterClick(\'READY\',this)">‚úÖ Ready'+(readyN?' ('+readyN+')':'')+'</div>';
    h+='<div class="sa-filter'+(SA_FILTER==="WATCH"?" on":"")+'" onclick="saFilterClick(\'WATCH\',this)">üëÄ Watch'+(watchN?' ('+watchN+')':'')+'</div>';
    h+='<div class="sa-filter'+(SA_FILTER==="WARNING"?" on-warn":"")+'" onclick="saFilterClick(\'WARNING\',this)">‚ö†Ô∏è Warning'+(warnN?' ('+warnN+')':'')+'</div>';
    h+='<input class="sa-search" placeholder="Search nifty / reliance / gold‚Ä¶" value="'+esc(SA_SEARCH)+'" oninput="saSearchInput(this.value)">';
    h+='<div class="sa-count" id="saCount"></div></div>';
    h+='<div class="sa-grid" id="saContainer"></div></div>';
    h+='<div class="sec"><div class="sec-label">üìà Indices</div><div class="grid5">';
    (C.indices||[]).forEach(x=>{const c=chgClass(x.changePct);const cName=prettySym(x.name).replace(/-EQ$/,"").trim();h+='<div class="idx-card" data-token="'+esc(String(x.token||""))+'" data-stockname="'+esc(cName)+'"><div class="idx-name">'+esc(prettySym(x.name))+'</div><div class="idx-ltp '+c+'">'+fN(x.ltp)+'</div><div class="idx-chg '+c+'">'+arrow(x.changePct)+' '+fP(Math.abs(x.change||0))+' ('+fP(Math.abs(x.changePct||0))+'%)</div><div class="idx-ohlc"><span>O:</span>'+fN(x.open)+' <span>H:</span>'+fN(x.high)+' <span>L:</span>'+fN(x.low)+' <span>C:</span>'+fN(x.close)+'</div></div>'});
    h+='</div></div>';
    const ready=[].concat(C.indices||[],C.stocks||[],C.commodities||[]).filter(x=>{const s=(x.engine?.signal||"").toUpperCase();return s==="BUY"||s==="SELL"}).slice(0,8);
    h+='<div class="sec"><div class="sec-label">üéØ Ready Trades</div><div class="grid">';
    if(ready.length){
      ready.forEach(x=>{h+=buildCard(x,true);const e=x.engine||{};logJ(x,(e.signal||"").toUpperCase(),fmt(e.trade),fmt(e.optionSuggestion),e.projectedTarget,e.stopLoss)});
    } else {
      // No BUY/SELL signals ‚Äî show top movers as "watch these"
      const allItems=[].concat(C.indices||[],C.stocks||[],C.commodities||[]).filter(x=>x.ltp>0);
      const topMovers=allItems.slice().sort((a,b)=>Math.abs(b.changePct||0)-Math.abs(a.changePct||0)).slice(0,4);
      const elapsedSec=WARMUP_FE.firstFetch?Math.round((Date.now()-WARMUP_FE.firstFetch)/1000):0;
      const cycleN=WARMUP_FE.cycles||0;
      if(cycleN<=2){
        h+='<div class="card"><div style="display:flex;align-items:center;gap:8px"><span class="spinner"></span><div><div style="font-weight:700">Engine warming up ‚Äî gathering candle data‚Ä¶</div><div class="muted" style="font-size:11px;margin-top:4px">Cycle '+cycleN+'/3 ‚Ä¢ This takes about 15‚Äì30 seconds. Signals will appear automatically.</div></div></div></div>';
      } else if(topMovers.length){
        h+='<div class="card" style="border-color:rgba(245,158,11,.2)"><div style="font-weight:700;color:#f59e0b;margin-bottom:8px">üìä No confirmed trades yet ‚Äî here are today\'s top movers</div><div class="muted" style="font-size:11px;margin-bottom:8px">These are moving the most today. The engine is monitoring for entry setups.</div></div>';
        topMovers.forEach(x=>{
          const c=chgClass(x.changePct);const nm=prettySym(x.name);const sc=x.engine?.score;
          h+='<div class="card"><div class="row"><div class="title">'+esc(nm)+'</div><div class="badges"><span class="badge '+(x.changePct>=0?"badge-pos":"badge-neg")+'">'+arrow(x.changePct)+fP(Math.abs(x.changePct))+'%</span>'+(sc!=null?'<span class="badge badge-na">Score: '+Math.round(sc)+'</span>':'')+'</div></div><div class="ltp">‚Çπ '+fP(x.ltp)+'</div><div class="kv">'+esc(x.engine?.reasonSimple||x.engine?.reason||"Watching for setup‚Ä¶")+'</div></div>';
        });
      } else {
        h+='<div class="card"><div class="muted">Waiting for market data‚Ä¶<span class="spinner"></span></div></div>';
      }
    }
    h+='</div></div>';
    h+='<div class="sec"><div class="sec-label">üìã Next Day Watchlist</div>';
    const wl=C.watchlist||[];
    if(!wl.length)h+='<div class="card"><div class="muted">Watchlist builds from active signals. Check after market hours.</div></div>';
    else{h+='<div class="card" style="padding:0;overflow:hidden">';wl.forEach(w=>{const c=chgClass(w.changePct);h+='<div class="wl-row"><div><b>'+esc(prettySym(w.name))+'</b> <span class="'+c+'">'+fP(w.changePct)+'%</span></div><div>'+sigBadge(w.signal)+'</div><div class="kv" style="margin:0">'+esc(fmtSym(w.option||w.trade||""))+'</div><div class="kv" style="margin:0">T: '+fP(w.target)+' | SL: '+fP(w.sl)+'</div></div>'});h+='</div>'}
    h+='</div>';dashEl.innerHTML=h;renderAlerts()}
  if(tradeEl){
    let h="";
    const allT=[].concat(C.indices||[],C.stocks||[],C.commodities||[]);
    // Show BUY/SELL cards first
    allT.forEach(x=>{const c=buildCard(x,true);if(c){h+=c;const e=x.engine||{};if((e.signal||"HOLD")!=="HOLD")logJ(x,e.signal.toUpperCase(),fmt(e.trade),fmt(e.optionSuggestion),e.projectedTarget,e.stopLoss)}});
    // If nothing rendered (all HOLD or showHold=false), show all instruments sorted by score
    if(!h){
      const sorted=allT.filter(x=>x.ltp>0).slice().sort((a,b)=>Math.abs((b.engine?.score||50)-50)-Math.abs((a.engine?.score||50)-50));
      sorted.forEach(x=>{
        const e=x.engine||{},sc=e.score||50,sig=(e.signal||"HOLD");
        const c=chgClass(x.changePct);const nm=prettySym(x.name);
        h+='<div class="card"><div class="row"><div class="title">'+esc(nm)+'</div><div class="badges">'+sigBadge(sig)+edgeBadge(e.edge||"NA")+'</div></div><div class="ltp '+c+'">‚Çπ '+fP(x.ltp)+' <span style="font-size:12px">'+arrow(x.changePct)+fP(Math.abs(x.changePct))+'%</span></div><div class="kv">Score: <b>'+Math.round(sc)+'</b>/100 ¬∑ '+esc(e.reasonSimple||e.reason||"Analyzing‚Ä¶")+'</div></div>';
      });
    }
    tradeEl.innerHTML=h||'<div class="card muted">Waiting for data‚Ä¶<span class="spinner"></span></div>'}
  if(stocksEl){let h="";(C.stocks||[]).forEach(x=>{const c=buildCard(x);if(c)h+=c});stocksEl.innerHTML=h||'<div class="card muted">No stocks</div>'}
  if(comEl){let h='<div class="sec"><div class="sec-label">üõ¢Ô∏è Commodity Futures Prices</div><div class="grid5">';const coms=C.commodities||[];if(!coms.length)h+='<div class="card muted">Resolving MCX futures contracts...</div>';else coms.forEach(x=>{const c=chgClass(x.changePct||x.change);const nm=prettySym(x.name);const icon=comIcon(x.name);h+='<div class="com-card"><div style="display:flex;align-items:center;gap:6px"><span class="com-icon">'+icon+'</span><span class="com-label">'+esc(nm)+'</span></div><div class="com-ltp '+c+'">‚Çπ '+fN(x.ltp)+'</div><div class="idx-chg '+c+'">'+arrow(x.changePct||x.change)+' '+fP(Math.abs(x.change||0))+' ('+fP(Math.abs(x.changePct||0))+'%)</div><div class="idx-ohlc"><span>O:</span>'+fN(x.open)+' <span>H:</span>'+fN(x.high)+' <span>L:</span>'+fN(x.low)+' <span>C:</span>'+fN(x.close)+'</div></div>'});h+='</div></div><div class="sec"><div class="sec-label">üìä Commodity Signals</div><div class="grid">';coms.forEach(x=>{const c=buildCard(x);if(c)h+=c});h+='</div></div>';comEl.innerHTML=h}
  const sel=document.getElementById("stockList");if(sel&&!sel.options.length)STOCK_LIST.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o)});
  renderJournal();
}
function renderJournal(){const g=document.getElementById("journalGrid");if(!g)return;const e=JOURNAL.slice(-30).reverse();if(!e.length){g.innerHTML='<div class="card muted">No entries yet</div>';return}g.innerHTML=e.map(j=>'<div class="card"><div class="kv"><b>'+esc(j.time||"")+'</b> ‚Äî <b>'+esc(prettySym(j.symbol))+'</b></div><div class="kv">'+sigBadge(j.signal)+' Trade: <b>'+esc(j.trade||"")+'</b></div><div class="kv">Option: <b>'+esc(j.option||"‚Äî")+'</b> LTP: <b>‚Çπ'+fP(j.ltp)+'</b></div><div class="kv">Target: <b>'+fP(j.target)+'</b> | SL: <b>'+fP(j.sl)+'</b></div></div>').join("")}

async function fetchGlobalData(){const el=document.getElementById("global");if(!el)return;const b=sessionStorage.getItem("B");if(!b)return;el.innerHTML='<div class="sec"><div class="sec-label">üåç Global Indices</div><div class="grid5"><div class="card">Loading...<span class="spinner"></span></div></div></div>';try{const r=await fetch(b+"/api/global-indices");const j=await r.json();if(!j?.ok||!j.data?.length){el.innerHTML='<div class="sec"><div class="card muted">Could not fetch global data</div></div>';return}let h='<div class="sec"><div class="sec-label">üåç Global Indices</div><div class="grid5">';j.data.forEach(g=>{if(g.error){h+='<div class="global-card"><div class="global-flag">'+esc(g.flag||"")+'</div><div class="global-name">'+esc(g.name)+'</div><div class="muted">Unavailable</div></div>';return}const c=chgClass(g.changePct);h+='<div class="global-card"><div class="global-flag">'+esc(g.flag||"üåê")+'</div><div class="global-name">'+esc(g.name)+' <span class="muted">('+esc(g.currency||"")+')</span></div><div class="global-ltp '+c+'">'+fN(g.ltp)+'</div><div class="global-chg '+c+'">'+arrow(g.changePct)+' '+fP(Math.abs(g.change||0))+' ('+fP(Math.abs(g.changePct||0))+'%)</div></div>'});h+='</div></div>';el.innerHTML=h}catch(e){el.innerHTML='<div class="sec"><div class="card muted">Failed to load</div></div>'}}

async function fetchNewsData(){const el=document.getElementById("news");if(!el)return;const b=sessionStorage.getItem("B");if(!b)return;el.innerHTML='<div class="sec"><div class="sec-label">üì∞ Market News</div><div class="card">Loading...<span class="spinner"></span></div></div>';try{const r=await fetch(b+"/api/news");const j=await r.json();if(!j?.ok||!j.data?.length){el.innerHTML='<div class="sec"><div class="card muted">No news available</div></div>';return}let h='<div class="sec"><div class="sec-label">üì∞ Market News <span class="muted" style="font-weight:400;letter-spacing:0">'+j.data.length+' articles</span></div><div class="card" style="padding:0;overflow:hidden">';j.data.slice(0,25).forEach(n=>{const ago=n.pubDate?timeAgo(new Date(n.pubDate)):"";h+='<div class="news-item"><div class="news-title"><a href="'+esc(n.link)+'" target="_blank">'+esc(n.title)+'</a></div><div class="news-meta"><span class="badge badge-na">'+esc(n.source)+'</span><span>'+esc(ago)+'</span></div>'+(n.description?'<div class="news-desc">'+esc(n.description)+'</div>':'')+'</div>'});h+='</div></div>';el.innerHTML=h}catch(e){el.innerHTML='<div class="sec"><div class="card muted">Failed</div></div>'}}
function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return"Just now";if(s<3600)return Math.floor(s/60)+" min ago";if(s<86400)return Math.floor(s/3600)+" hr ago";return Math.floor(s/86400)+" days ago"}

function filterStocks(){const t=document.getElementById("searchStock").value.toLowerCase();[...document.getElementById("stockList").options].forEach(o=>o.style.display=o.value.toLowerCase().includes(t)?"":"none")}
async function runBacktest(){const stock=document.getElementById("stockList").value,out=document.getElementById("btResult");out.innerHTML='<div class="card">Analyzing '+esc(stock)+'...<span class="spinner"></span></div>';try{const b=sessionStorage.getItem("B"),jwt=sessionStorage.getItem("T");if(!b||!jwt){out.innerHTML='<div class="card muted">Login first</div>';return}const r=await fetch(b+"/api/backtest/stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:stock,exchange:"NSE",jwtToken:jwt})});const j=await r.json();if(!j?.ok){out.innerHTML='<div class="card">'+esc(j?.error||"Failed")+'</div>';return}const w=j.winRate,sig=j.signal,conf=j.confidence||"‚Äî",ltp=j.ltp,sc=sig==="BUY"?"green":sig==="SELL"?"red":"";let sug="",msg="";if(sig==="BUY"&&w>=55){sug="BUY "+stock;msg="Bullish EMA crossover confirmed"}else if(sig==="SELL"&&w>=55){sug="SELL "+stock;msg="Bearish EMA crossover confirmed"}else if(sig!=="HOLD"){sug="WAIT ‚Äî Low confidence";msg="Signal present but weak win rate"}else{sug="NO TRADE";msg="No active crossover"}let tgt="‚Äî",sl="‚Äî";if(sig==="BUY"&&isFinite(ltp)){tgt=fP(ltp*1.012);sl=fP(ltp*.993)}else if(sig==="SELL"&&isFinite(ltp)){tgt=fP(ltp*.988);sl=fP(ltp*1.007)}let patStr="";if(j.patterns?.length)patStr='<div style="margin-top:8px">'+patHTML(j.patterns)+'</div>';let extras="";if(j.bollinger)extras+='<div class="kv">Bollinger: <b>'+fP(j.bollinger.lower)+'</b> ‚Äî <b>'+fP(j.bollinger.middle)+'</b> ‚Äî <b>'+fP(j.bollinger.upper)+'</b></div>';if(j.macd)extras+='<div class="kv">MACD: <b>'+fP(j.macd.line)+'</b> Signal: <b>'+fP(j.macd.signal)+'</b> Hist: <b class="'+(j.macd.histogram>=0?"green":"red")+'">'+fP(j.macd.histogram)+'</b></div>';if(j.supertrend)extras+='<div class="kv">Supertrend: <b>'+fP(j.supertrend.value)+'</b> <span class="badge '+(j.supertrend.trend==="BULLISH"?"badge-buy":"badge-sell")+'">'+j.supertrend.trend+'</span></div>';const pulse=w>=60?"pulse-good":w<=45?"pulse-bad":"";out.innerHTML='<div class="card '+pulse+'"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:20px;font-weight:800">'+esc(stock)+'</div><div class="muted" style="font-size:11px">'+esc(j.strategy||"EMA 9/21")+' ¬∑ '+j.candleCount+' candles</div></div><span class="pill '+(sig==="BUY"?"buy":sig==="SELL"?"sell":"hold")+'">'+sig+'</span></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px"><div class="kv">Win Rate<br><b style="font-size:18px" class="'+sc+'">'+w+'%</b></div><div class="kv">Trades<br><b style="font-size:18px">'+j.totalTrades+'</b></div><div class="kv">Avg P&L<br><b style="font-size:18px" class="'+(j.avgPnl>=0?"green":"red")+'">‚Çπ'+fP(j.avgPnl)+'</b></div><div class="kv">RSI(14)<br><b style="font-size:18px">'+fP(j.rsi)+'</b></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px"><div class="kv">EMA Fast: <b>'+fP(j.emaFast)+'</b> / Slow: <b>'+fP(j.emaSlow)+'</b></div><div class="kv">Confidence: <b>'+esc(conf)+'</b></div></div>'+extras+patStr+'<div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(148,163,184,.1)"><div class="sec-label" style="margin-bottom:4px">RECOMMENDATION</div><div style="font-size:18px;font-weight:900" class="'+sc+'">'+esc(sug)+'</div><div class="kv">LTP: <b>‚Çπ'+fP(ltp)+'</b> ¬∑ Target: <b>'+tgt+'</b> ¬∑ SL: <b>'+sl+'</b></div><div class="muted" style="font-size:11px;margin-top:4px">'+esc(msg)+'</div></div></div>'}catch(e){out.innerHTML='<div class="card">Error: '+esc(e.message)+'</div>'}}

async function runMC(){const stock=document.getElementById("stockList").value,out=document.getElementById("mcOut");out.innerHTML='Running Monte Carlo on <b>'+esc(stock)+'</b>...<span class="spinner"></span>';try{const b=sessionStorage.getItem("B"),jwt=sessionStorage.getItem("T");if(!b||!jwt){out.innerHTML='<div class="bt-warn neg">Login first</div>';return}const r=await fetch(b+"/api/backtest/montecarlo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jwtToken:jwt,symbol:stock,exchange:"NSE",days:20,paths:1000})});const j=await r.json();if(!j?.ok){out.innerHTML='<div class="bt-warn neg">MC failed: '+esc(j?.error||"Error")+'</div>';return}const s=j.stats,up=s.winUp0_5??0;const label=up>=55?"POSITIVE":up>=50?"NEUTRAL":"NEGATIVE";let warn="";if(up<50)warn='<div class="bt-warn neg">‚ö†Ô∏è <b>Statistical edge is NEGATIVE</b> for '+esc(stock)+'. Probability of 0.5% gain: '+up+'%. Avoid trading.</div>';else if(up<55)warn='<div class="bt-warn amb">‚ö° Marginal edge for '+esc(stock)+'. Consider waiting for stronger conviction.</div>';else warn='<div class="bt-warn pos">‚úÖ <b>Positive edge detected</b> for '+esc(stock)+'. Conditions favor directional trades with risk management.</div>';out.innerHTML='<div class="card"><div class="kv" style="font-size:14px">Monte Carlo ‚Äî <b>'+esc(stock)+'</b>: <span class="pill '+(label==="POSITIVE"?"buy":label==="NEGATIVE"?"sell":"hold")+'">'+label+'</span></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px"><div class="kv">Win‚â•0.5%<br><b style="font-size:16px">'+up+'%</b></div><div class="kv">P10<br><b>‚Çπ'+fN(s.p10)+'</b></div><div class="kv">P50<br><b>‚Çπ'+fN(s.p50)+'</b></div><div class="kv">P90<br><b>‚Çπ'+fN(s.p90)+'</b></div></div>'+warn+'</div>'}catch(e){out.innerHTML='<div class="bt-warn neg">Error: '+esc(e.message)+'</div>'}}

async function run52Week(){
  const stock=document.getElementById("stockList").value,out=document.getElementById("w52Out");
  out.innerHTML='<div class="card">üìÖ Loading 1 year of daily data for <b>'+esc(stock)+'</b>...<span class="spinner"></span></div>';
  try{
    const b=sessionStorage.getItem("B"),jwt=sessionStorage.getItem("T");
    if(!b||!jwt){out.innerHTML='<div class="card muted">Login first</div>';return}
    const r=await fetch(b+"/api/backtest/52week",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:stock,exchange:"NSE",jwtToken:jwt})});
    const j=await r.json();
    if(!j?.ok){out.innerHTML='<div class="card">'+esc(j?.error||"Failed")+'</div>';return}

    const sig=j.signal||"HOLD",sc=sig==="BUY"?"green":sig==="SELL"?"red":"";
    const pulse=j.winRate>=55?"pulse-good":j.winRate<=40?"pulse-bad":"";
    const pos=j.positionPct||0;

    // 52W Range bar visualization
    const barColor=pos<25?"#ef4444":pos>75?"#10b981":"#f59e0b";
    const rangeBar='<div style="margin:10px 0"><div class="muted" style="font-size:11px;margin-bottom:4px">Position in 52-Week Range</div><div style="background:#1e293b;border-radius:8px;height:24px;position:relative;overflow:hidden"><div style="background:'+barColor+';height:100%;width:'+Math.max(2,pos)+'%;border-radius:8px;transition:width .5s"></div><div style="position:absolute;top:3px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:800">'+fP(pos)+'%</div></div><div style="display:flex;justify-content:space-between;font-size:10px;color:#64748b;margin-top:2px"><span>52W Low: ‚Çπ'+fN(j.low52W)+'</span><span>LTP: ‚Çπ'+fN(j.ltp)+'</span><span>52W High: ‚Çπ'+fN(j.high52W)+'</span></div></div>';

    // Zone badge
    let zoneBadge='';
    if(j.isNear52WLow)zoneBadge='<span class="badge badge-sell" style="font-size:11px">üîª Near 52W Low</span>';
    else if(j.isNear52WHigh)zoneBadge='<span class="badge badge-buy" style="font-size:11px">üî∫ Near 52W High</span>';
    else if(j.isInBounceZone)zoneBadge='<span class="badge" style="background:rgba(245,158,11,.15);color:#f59e0b;font-size:11px">‚ö° Bounce Zone</span>';
    else if(j.isInBreakoutZone)zoneBadge='<span class="badge" style="background:rgba(16,185,129,.15);color:#10b981;font-size:11px">üöÄ Breakout Zone</span>';

    // Trend badge
    const trendColors={"BULLISH":"green","BEARISH":"red","RECOVERING":"amber","WEAKENING":"red","SIDEWAYS":""};
    const trendBadge='<span class="badge badge-'+(j.trend==="BULLISH"?"buy":j.trend==="BEARISH"?"sell":"na")+'">'+esc(j.trend||"‚Äî")+'</span>';

    // Strategy breakdown
    let stratBreak='';
    if(j.byType){
      stratBreak='<div style="margin-top:8px"><div class="muted" style="font-size:11px;margin-bottom:4px">Strategy Breakdown</div>';
      const typeLabels={"BOUNCE_BUY":"üîÑ Bounce Buy","MOMENTUM_BUY":"üöÄ Momentum","RECOVERY_BUY":"üìà Recovery"};
      for(const[k,v]of Object.entries(j.byType)){
        stratBreak+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px;border-bottom:1px solid rgba(148,163,184,.06)"><span>'+(typeLabels[k]||k)+'</span><span>'+v.trades+' trades ¬∑ <b class="'+(v.winRate>=50?"green":"red")+'">'+v.winRate+'%</b> win ¬∑ Avg '+fP(v.avgPnlPct)+'%</span></div>';
      }
      stratBreak+='</div>';
    }

    // Recent trades
    let recentHTML='';
    if(j.recentTrades?.length){
      recentHTML='<div style="margin-top:8px"><div class="muted" style="font-size:11px;margin-bottom:4px">Recent Backtested Trades</div>';
      j.recentTrades.forEach(t=>{
        const pc=t.pnlPct>=0?"green":"red";
        const typeLabel={"BOUNCE_BUY":"Bounce","MOMENTUM_BUY":"Momentum","RECOVERY_BUY":"Recovery"}[t.type]||t.type;
        recentHTML+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:11px;border-bottom:1px solid rgba(148,163,184,.06)"><span>'+esc(typeLabel)+' ‚Çπ'+fP(t.entry)+' ‚Üí ‚Çπ'+fP(t.exit)+'</span><span class="'+pc+'"><b>'+(t.pnlPct>=0?"+":"")+fP(t.pnlPct)+'%</b> ('+t.holdDays+'d, '+esc(t.exitReason)+')'+(t.open?' <span class="amber">OPEN</span>':'')+'</span></div>';
      });
      recentHTML+='</div>';
    }

    out.innerHTML='<div class="card '+pulse+'"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:20px;font-weight:800">'+esc(stock)+' ‚Äî 52-Week Analysis</div><div class="muted" style="font-size:11px">'+esc(j.strategy||"52W Hybrid")+' ¬∑ '+j.candleCount+' daily candles ¬∑ '+j.tradingDays+' trading days</div></div><span class="pill '+(sig==="BUY"?"buy":sig==="SELL"?"sell":"hold")+'">'+sig+'</span></div>'+rangeBar+'<div style="display:flex;gap:6px;flex-wrap:wrap;margin:8px 0">'+zoneBadge+trendBadge+(j.multipleBottoms?'<span class="badge badge-na">üîÅ Multiple Bottoms ('+j.lowTests+'x)</span>':'')+(j.volumeSpike?'<span class="badge" style="background:rgba(59,130,246,.15);color:#60a5fa">üìä Volume Spike ('+j.volumeRatio+'x)</span>':'')+'</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px"><div class="kv">Win Rate<br><b style="font-size:18px" class="'+sc+'">'+j.winRate+'%</b></div><div class="kv">Trades<br><b style="font-size:18px">'+j.totalTrades+'</b></div><div class="kv">Avg P&L<br><b style="font-size:18px" class="'+(j.avgPnl>=0?"green":"red")+'">‚Çπ'+fP(j.avgPnl)+'</b></div><div class="kv">RSI(14)<br><b style="font-size:18px">'+(j.rsi!=null?fP(j.rsi):"‚Äî")+'</b></div></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px"><div class="kv">Avg Win<br><b class="green">+'+fP(j.avgWin)+'%</b></div><div class="kv">Avg Loss<br><b class="red">'+fP(j.avgLoss)+'%</b></div><div class="kv">Max DD<br><b class="red">-'+fP(j.maxDrawdownPct)+'%</b></div><div class="kv">Profit Factor<br><b>'+(j.profitFactor||"‚Äî")+'</b></div></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px"><div class="kv">EMA20: <b>‚Çπ'+fP(j.ema20)+'</b></div><div class="kv">EMA50: <b>‚Çπ'+fP(j.ema50)+'</b></div><div class="kv">POC: <b>‚Çπ'+fP(j.poc)+'</b></div></div>'+stratBreak+recentHTML+'<div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(148,163,184,.1)"><div class="sec-label" style="margin-bottom:4px">üìã RECOMMENDATION</div><div style="font-size:16px;font-weight:900;line-height:1.4" class="'+sc+'">'+esc(j.recommendation||"No clear setup")+'</div>'+(j.projectedTarget||j.stopLoss?'<div class="kv" style="margin-top:6px">LTP: <b>‚Çπ'+fP(j.ltp)+'</b>'+(j.projectedTarget?' ¬∑ Target: <b class="green">‚Çπ'+fP(j.projectedTarget)+'</b>':'')+(j.stopLoss?' ¬∑ SL: <b class="red">‚Çπ'+fP(j.stopLoss)+'</b>':'')+'</div>':'')+'<div class="muted" style="font-size:11px;margin-top:6px">Expectancy per trade: <b>'+(j.expectancy>=0?"+":"")+fP(j.expectancy)+'%</b> ¬∑ Avg hold: <b>'+fP(j.avgHoldDays)+' days</b> ¬∑ Confidence: <b>'+esc(j.confidence||"‚Äî")+'</b></div></div></div>';
  }catch(e){out.innerHTML='<div class="card">Error: '+esc(e.message)+'</div>'}}

// ‚ïê‚ïê‚ïê DISCOVER TAB ‚Äî Stock Screener ‚ïê‚ïê‚ïê
function showDiscoverSection(which){
  const inv=document.getElementById("discoverInvest"),fno=document.getElementById("discoverFnO");
  const b1=document.getElementById("discBtn1"),b2=document.getElementById("discBtn2");
  if(which==="invest"){inv.style.display="";fno.style.display="none";b1.style.background="#1e293b";b1.style.color="#f1f5f9";b2.style.background="transparent";b2.style.color="#94a3b8"}
  else{inv.style.display="none";fno.style.display="";b2.style.background="#1e293b";b2.style.color="#f1f5f9";b1.style.background="transparent";b1.style.color="#94a3b8"}
}

async function runScreener(){
  const invOut=document.getElementById("discoverInvest"),fnoOut=document.getElementById("discoverFnO");
  invOut.innerHTML='<div class="card">üîç Scanning 90+ stocks across Nifty 50 & top F&O...<span class="spinner"></span></div>';
  fnoOut.innerHTML='<div class="card">Loading...<span class="spinner"></span></div>';
  try{
    const b=sessionStorage.getItem("B"),jwt=sessionStorage.getItem("T");
    if(!b||!jwt){invOut.innerHTML='<div class="card muted">Login first</div>';return}
    const r=await fetch(b+"/api/screener",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jwtToken:jwt})});
    const j=await r.json();
    if(!j?.ok){invOut.innerHTML='<div class="card">'+esc(j?.error||"Failed")+'</div>';return}

    // Investment Picks
    let iHTML='<div class="sec-label" style="margin-bottom:8px">üìà Top Investment Picks ‚Äî Stocks with value + recovery potential <span class="muted" style="font-size:11px">('+j.totalScanned+' scanned)</span></div>';
    iHTML+='<div style="display:grid;gap:2px">';
    (j.investPicks||[]).forEach((p,i)=>{
      const sc=p.investScore>=65?"green":p.investScore>=50?"":"red";
      const pos=p.pos52||0;
      const barColor=pos<25?"#ef4444":pos>75?"#10b981":"#f59e0b";
      const badge=pos<=25?'<span class="badge badge-sell" style="font-size:10px">VALUE</span>':pos>=75?'<span class="badge badge-buy" style="font-size:10px">MOMENTUM</span>':'<span class="badge badge-na" style="font-size:10px">MID-RANGE</span>';
      iHTML+='<div class="card" style="padding:10px 14px;display:flex;justify-content:space-between;align-items:center;gap:8px">'
        +'<div style="min-width:100px"><b>'+esc(p.name)+'</b><div class="muted" style="font-size:10px">‚Çπ'+fN(p.ltp)+' <span class="'+(p.changePct>=0?"green":"red")+'">'+(p.changePct>=0?"+":"")+fP(p.changePct)+'%</span></div></div>'
        +'<div style="flex:1;max-width:120px"><div style="background:#1e293b;border-radius:4px;height:8px;overflow:hidden"><div style="background:'+barColor+';height:100%;width:'+Math.max(2,pos)+'%"></div></div><div class="muted" style="font-size:9px;text-align:center">'+fP(pos)+'% of 52W</div></div>'
        +'<div style="text-align:right;min-width:60px">'+badge+'<div class="kv '+sc+'" style="font-size:13px;font-weight:800">'+p.investScore+'/100</div></div>'
        +'<div style="flex:2;font-size:11px;color:#94a3b8">'+esc(p.investReason||"")+'</div>'
        +'<button onclick="addToWatchlistDirect(\''+esc(p.name)+'\')" style="padding:4px 8px;background:transparent;border:1px solid #334155;color:#94a3b8;border-radius:6px;cursor:pointer;font-size:11px" title="Add to watchlist">‚≠ê</button>'
        +'</div>';
    });
    iHTML+='</div>';
    iHTML+='<div class="card muted" style="font-size:11px;margin-top:10px;padding:10px">üí° <b>How investors target 12-15% returns:</b> Focus on stocks in the VALUE zone (bottom 25% of 52-week range) with recovering trends. Historical Nifty 50 average return is ~12% annually. Stocks near 52W lows with strong fundamentals statistically bounce 60%+ of the time. Use 52-Week Analysis in Backtesting tab for detailed entry/exit levels.</div>';
    invOut.innerHTML=iHTML;

    // F&O Picks
    let fHTML='<div class="sec-label" style="margin-bottom:8px">‚ö° F&O Trading Opportunities ‚Äî High volatility + directional stocks <span class="muted" style="font-size:11px">('+j.totalScanned+' scanned)</span></div>';
    fHTML+='<div style="display:grid;gap:2px">';
    (j.fnoPicks||[]).forEach((p,i)=>{
      const sc=p.fnoScore>=65?"green":p.fnoScore>=50?"":"red";
      const dirBadge=p.direction==="BULLISH"?'<span class="badge badge-buy" style="font-size:10px">üìà BUY CE</span>':p.direction==="BEARISH"?'<span class="badge badge-sell" style="font-size:10px">üìâ BUY PE</span>':'<span class="badge badge-na" style="font-size:10px">‚è∏ WAIT</span>';
      fHTML+='<div class="card" style="padding:10px 14px;display:flex;justify-content:space-between;align-items:center;gap:8px">'
        +'<div style="min-width:100px"><b>'+esc(p.name)+'</b><div class="muted" style="font-size:10px">‚Çπ'+fN(p.ltp)+' <span class="'+(p.changePct>=0?"green":"red")+'">'+(p.changePct>=0?"+":"")+fP(p.changePct)+'%</span></div></div>'
        +'<div style="min-width:80px;text-align:center"><div style="font-size:11px;color:#94a3b8">Range</div><b style="font-size:14px">'+fP(p.intradayRange)+'%</b></div>'
        +dirBadge
        +'<div style="text-align:right;min-width:60px"><div class="kv '+sc+'" style="font-size:13px;font-weight:800">'+p.fnoScore+'/100</div></div>'
        +'<div style="flex:2;font-size:11px;color:#94a3b8">'+esc(p.fnoReason||"")+'</div>'
        +'<button onclick="addToWatchlistDirect(\''+esc(p.name)+'\')" style="padding:4px 8px;background:transparent;border:1px solid #334155;color:#94a3b8;border-radius:6px;cursor:pointer;font-size:11px" title="Add to watchlist">‚≠ê</button>'
        +'</div>';
    });
    fHTML+='</div>';
    fHTML+='<div class="card muted" style="font-size:11px;margin-top:10px;padding:10px">üí° <b>How F&O traders select stocks:</b> Look for high intraday range (1.5%+), strong directional moves, and volume spikes. Put-Call Ratio (PCR) > 1 = bearish sentiment (contrarian BUY CE), PCR < 0.7 = bullish (contrarian BUY PE). Combine with OI analysis ‚Äî highest Call OI = resistance, highest Put OI = support. Options chain integration coming in Phase 2.</div>';
    fnoOut.innerHTML=fHTML;
  }catch(e){invOut.innerHTML='<div class="card">Error: '+esc(e.message)+'</div>'}
}

// ‚ïê‚ïê‚ïê EDITABLE WATCHLIST ‚ïê‚ïê‚ïê
function saveWatchlist(){localStorage.setItem("TG32_WATCHLIST",JSON.stringify(MY_WATCHLIST))}

function addToWatchlist(){
  const input=document.getElementById("wlAddInput");
  const name=(input.value||"").trim().toUpperCase().replace(/-EQ$/,"");
  if(!name){return}
  if(MY_WATCHLIST.includes(name)){input.value="";renderWatchlist();return}
  MY_WATCHLIST.push(name);saveWatchlist();input.value="";
  renderWatchlist();refreshWatchlist();
}

function addToWatchlistDirect(name){
  name=name.trim().toUpperCase();
  if(MY_WATCHLIST.includes(name))return;
  MY_WATCHLIST.push(name);saveWatchlist();
  renderWatchlist();
}

function removeFromWatchlist(name){
  MY_WATCHLIST=MY_WATCHLIST.filter(n=>n!==name);saveWatchlist();
  renderWatchlist();
}

function renderWatchlist(){
  const grid=document.getElementById("wlGrid"),empty=document.getElementById("wlEmpty");
  if(!MY_WATCHLIST.length){grid.innerHTML="";empty.style.display="";return}
  empty.style.display="none";
  // Show watchlist with last known data or placeholders
  let html="";
  MY_WATCHLIST.forEach(name=>{
    const cached=WL_QUOTES[name];
    if(cached){
      const c=cached;
      html+='<div class="card" style="position:relative"><button onclick="removeFromWatchlist(\''+esc(name)+'\')" style="position:absolute;top:6px;right:8px;background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px" title="Remove">‚úï</button>'
        +'<div style="font-weight:800;font-size:15px">'+esc(name)+'</div>'
        +'<div style="font-size:20px;font-weight:800;margin:4px 0">‚Çπ'+fN(c.ltp)+'</div>'
        +'<div class="'+(c.changePct>=0?"green":"red")+'" style="font-size:13px;font-weight:700">'+(c.changePct>=0?"+":"")+fP(c.changePct)+'%</div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px;font-size:11px">'
        +'<div class="kv">O: ‚Çπ'+fN(c.open)+'</div><div class="kv">H: ‚Çπ'+fN(c.high)+'</div>'
        +'<div class="kv">L: ‚Çπ'+fN(c.low)+'</div><div class="kv">C: ‚Çπ'+fN(c.close)+'</div></div>'
        +(c.high52?'<div style="margin-top:4px;font-size:10px;color:#64748b">52W: ‚Çπ'+fN(c.low52)+' ‚Äî ‚Çπ'+fN(c.high52)+'</div>':'')
        +'</div>';
    }else{
      html+='<div class="card" style="position:relative"><button onclick="removeFromWatchlist(\''+esc(name)+'\')" style="position:absolute;top:6px;right:8px;background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px" title="Remove">‚úï</button>'
        +'<div style="font-weight:800">'+esc(name)+'</div><div class="muted" style="font-size:12px">Click Refresh to load prices</div></div>';
    }
  });
  grid.innerHTML=html;
}

let WL_QUOTES={};
async function refreshWatchlist(){
  if(!MY_WATCHLIST.length)return;
  try{
    const b=sessionStorage.getItem("B"),jwt=sessionStorage.getItem("T");
    if(!b||!jwt)return;
    const r=await fetch(b+"/api/watchlist/quotes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbols:MY_WATCHLIST,jwtToken:jwt})});
    const j=await r.json();
    if(j?.ok&&j.quotes){
      j.quotes.forEach(q=>{WL_QUOTES[q.name]=q});
      renderWatchlist();
    }
  }catch(e){console.log("WL refresh err:",e)}
}

// ‚ïê‚ïê‚ïê WATCHLIST AUTO-REFRESH (every 30s when on watchlist tab) ‚ïê‚ïê‚ïê
let wlAutoTimer=null;
function startWLAutoRefresh(){
  stopWLAutoRefresh();
  if(MY_WATCHLIST.length) refreshWatchlist();
  wlAutoTimer=setInterval(()=>{
    if(document.getElementById("watchlist")?.style.display!=="none"&&MY_WATCHLIST.length){
      refreshWatchlist();
    }
  },30000);
}
function stopWLAutoRefresh(){if(wlAutoTimer){clearInterval(wlAutoTimer);wlAutoTimer=null}}

// ‚ïê‚ïê‚ïê CONTEXT MENU ‚Äî Right-click on any stock card ‚ïê‚ïê‚ïê
let CTX_STOCK="";
function showCtxMenu(e,stockName){
  e.preventDefault();e.stopPropagation();
  CTX_STOCK=(stockName||"").trim().toUpperCase().replace(/-EQ$/,"");
  if(!CTX_STOCK)return;
  const menu=document.getElementById("ctxMenu");
  menu.style.display="block";
  const x=Math.min(e.clientX,window.innerWidth-200);
  const y=Math.min(e.clientY,window.innerHeight-260);
  menu.style.left=x+"px";menu.style.top=y+"px";
  // Toggle remove vs add
  const isInWL=MY_WATCHLIST.includes(CTX_STOCK);
  menu.children[0].style.display=isInWL?"none":"";
  menu.children[1].style.display=isInWL?"":"none";
}
document.addEventListener("click",()=>{document.getElementById("ctxMenu").style.display="none"});
document.addEventListener("contextmenu",e=>{
  const card=e.target.closest(".card,.idx-card");
  if(!card)return;
  // Extract stock name from card
  let name="";
  if(card.dataset.stockname) name=card.dataset.stockname;
  else{
    const titleEl=card.querySelector(".title,.idx-name,.sa-name,b");
    if(titleEl) name=titleEl.textContent.trim();
  }
  // Clean emoji/prefixes
  name=name.replace(/^[üîÑüöÄüìàüìâ‚ö°üî•‚ö†Ô∏èüí°üìäüß™üéØüîç‚≠ê‚ùå]+\s*/,"").replace(/\s*‚Äî.*$/,"").trim();
  if(!name||name.length<2||name.length>20||/\d{3,}/.test(name))return;
  showCtxMenu(e,name);
});

function ctxAddWatchlist(){
  if(CTX_STOCK&&!MY_WATCHLIST.includes(CTX_STOCK)){
    MY_WATCHLIST.push(CTX_STOCK);saveWatchlist();renderWatchlist();
    showToast("‚≠ê Added to Watchlist",CTX_STOCK+" added to your watchlist","#0ea5e9");
  }
}
function ctxRemoveWatchlist(){
  if(CTX_STOCK){
    MY_WATCHLIST=MY_WATCHLIST.filter(n=>n!==CTX_STOCK);saveWatchlist();renderWatchlist();
    showToast("‚ùå Removed",CTX_STOCK+" removed from watchlist","#ef4444");
  }
}
function ctxBacktest(){
  if(!CTX_STOCK)return;
  switchTab("backtest",document.querySelector('.tab[onclick*="backtest"]'));
  const sel=document.getElementById("stockList");
  if(sel){for(const o of sel.options){if(o.value===CTX_STOCK){sel.value=CTX_STOCK;break}}}
  setTimeout(()=>runBacktest(),200);
}
function ctx52Week(){
  if(!CTX_STOCK)return;
  switchTab("backtest",document.querySelector('.tab[onclick*="backtest"]'));
  const sel=document.getElementById("stockList");
  if(sel){for(const o of sel.options){if(o.value===CTX_STOCK){sel.value=CTX_STOCK;break}}}
  setTimeout(()=>run52Week(),200);
}
function ctxGreeks(){
  if(!CTX_STOCK)return;
  switchTab("backtest",document.querySelector('.tab[onclick*="backtest"]'));
  const q=WL_QUOTES[CTX_STOCK];
  if(q&&q.ltp){document.getElementById("gkSpot").value=Math.round(q.ltp);document.getElementById("gkStrike").value=Math.round(q.ltp/50)*50}
  else{
    const all=[].concat(C.indices||[],C.stocks||[],C.commodities||[]);
    const found=all.find(x=>(x.name||"").toUpperCase().includes(CTX_STOCK));
    if(found&&found.ltp){document.getElementById("gkSpot").value=Math.round(found.ltp);document.getElementById("gkStrike").value=Math.round(found.ltp/50)*50}
  }
  setTimeout(()=>document.getElementById("gkSpot").scrollIntoView({behavior:"smooth"}),300);
}

// ‚ïê‚ïê‚ïê NOTIFICATION TOAST SYSTEM ‚ïê‚ïê‚ïê
let toastCount=0;
function showToast(title,body,color){
  const area=document.getElementById("notifArea");
  const id="toast_"+(++toastCount);
  const div=document.createElement("div");div.className="notif-toast";div.id=id;
  div.style.borderColor=color||"#10b981";
  div.innerHTML='<div class="nt-title">'+esc(title)+'</div><div class="nt-body">'+esc(body)+'</div>';
  div.onclick=()=>{div.classList.add("nt-exit");setTimeout(()=>div.remove(),300)};
  area.appendChild(div);
  setTimeout(()=>{if(document.getElementById(id)){div.classList.add("nt-exit");setTimeout(()=>div.remove(),300)}},8000);
}

// Browser notification
function requestNotifPermission(){
  if("Notification" in window && Notification.permission==="default") Notification.requestPermission();
}
function sendBrowserNotif(title,body){
  if("Notification" in window && Notification.permission==="granted"){
    try{new Notification(title,{body,icon:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßû</text></svg>"})}catch(e){}
  }
}

// ‚ïê‚ïê‚ïê SSE LISTENER FOR PUSH ALERTS ‚ïê‚ïê‚ïê
function connectAlertSSE(){
  const b=sessionStorage.getItem("B");
  if(!b)return;
  try{
    const es=new EventSource(b+"/api/sse");
    es.addEventListener("alert_ready",e=>{
      try{
        const d=JSON.parse(e.data);
        const title="üö® "+d.name+" ‚Äî "+(d.label||d.type||"Alert");
        const body=(d.action||"")+"\nEntry: ‚Çπ"+(d.trigger||"‚Äî")+" | T: ‚Çπ"+(d.target1||"‚Äî")+" | SL: ‚Çπ"+(d.sl||"‚Äî")+"\n"+(d.optionHint||"");
        showToast(title,body,"#10b981");
        sendBrowserNotif(title,body);
      }catch(ex){}
    });
    es.onerror=()=>{es.close();setTimeout(connectAlertSSE,10000)};
  }catch(e){}
}

// ‚ïê‚ïê‚ïê IN-APP ALERT NOTIFICATIONS (poll-based backup) ‚ïê‚ïê‚ïê
let LAST_READY_ALERTS={};
function checkNewAlerts(){
  const al=(C.alerts||[]).filter(a=>(a.category||"").toUpperCase()==="READY"||(a.status||"").toUpperCase()==="READY");
  for(const a of al){
    const key=(a.name||"")+"_"+(a.type||"")+"_"+(a.direction||"");
    if(LAST_READY_ALERTS[key])continue;
    LAST_READY_ALERTS[key]=Date.now();
    const title="üö® "+(a.name||"?")+" ‚Äî "+(a.label||a.type||"Alert");
    const body=(a.action||a.message||"Trade opportunity detected")+"\n"+(a.oneLiner||"");
    showToast(title,body,"#10b981");
    sendBrowserNotif(title,body);
  }
  // Clean old keys (>15 min)
  const now=Date.now();
  for(const k in LAST_READY_ALERTS){if(now-LAST_READY_ALERTS[k]>900000)delete LAST_READY_ALERTS[k]}
}

// ‚ïê‚ïê‚ïê GREEKS CALCULATOR ‚ïê‚ïê‚ïê
async function calcGreeks(){
  const S=+document.getElementById("gkSpot").value;
  const K=+document.getElementById("gkStrike").value;
  const T_days=+document.getElementById("gkDays").value;
  const sigma=(+document.getElementById("gkIV").value)/100;
  const r=(+document.getElementById("gkRate").value)/100;
  const type=document.getElementById("gkType").value;
  const out=document.getElementById("greeksResult");

  if(!S||!K||!T_days||!sigma){out.innerHTML='<div class="card muted">Please fill all fields</div>';return}

  try{
    const b=sessionStorage.getItem("B");
    const res=await fetch(b+"/api/options/greeks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({S,K,T_days,r,sigma,type})});
    const g=await res.json();
    if(!g.ok){out.innerHTML='<div class="card muted">Invalid inputs ‚Äî check spot/strike must be > 0, days > 0</div>';return}

    // Calculate theoretical premium (Black-Scholes)
    const T=T_days/365;const sT=Math.sqrt(T);
    const d1=(Math.log(S/K)+(r+.5*sigma*sigma)*T)/(sigma*sT);
    const d2=d1-sigma*sT;
    const cdf=x=>{const L=Math.abs(x),k=1/(1+.2316419*L),w=1-Math.exp(-.5*x*x)/Math.sqrt(2*Math.PI)*(.3193815*k-.3565638*k**2+1.781478*k**3-1.821256*k**4+1.330274*k**5);return x<0?1-w:w};
    let premium;
    if(type==="CE") premium=S*cdf(d1)-K*Math.exp(-r*T)*cdf(d2);
    else premium=K*Math.exp(-r*T)*cdf(-d2)-S*cdf(-d1);
    const intrinsic=type==="CE"?Math.max(0,S-K):Math.max(0,K-S);
    const timeVal=Math.max(0,premium-intrinsic);
    const moneyness=type==="CE"?(S>K?"ITM":S===K?"ATM":"OTM"):(S<K?"ITM":S===K?"ATM":"OTM");
    const breakeven=type==="CE"?K+premium:K-premium;
    const maxLoss=premium;
    const leverageRatio=S>0?(premium>0?(S/premium).toFixed(1)+"x":"‚àû"):"‚Äî";

    const dc=g.delta>=0?"green":"red";
    const tc=g.theta>=0?"green":"red";

    out.innerHTML='<div class="card" style="margin-top:12px">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div><b style="font-size:16px">'+type+' '+K+'</b> <span class="badge '+(moneyness==="ITM"?"badge-buy":moneyness==="OTM"?"badge-sell":"badge-na")+'">'+moneyness+'</span></div>'
      +'<div style="text-align:right"><div style="font-size:11px;color:#64748b">Theoretical Premium</div><div style="font-size:24px;font-weight:900;color:#10b981">‚Çπ'+premium.toFixed(2)+'</div></div></div>'
      +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px;font-size:12px"><div class="kv">Intrinsic: <b>‚Çπ'+intrinsic.toFixed(2)+'</b></div><div class="kv">Time Value: <b>‚Çπ'+timeVal.toFixed(2)+'</b></div><div class="kv">Breakeven: <b>‚Çπ'+breakeven.toFixed(2)+'</b></div></div>'
      +'<div class="greek-result">'
      +'<div class="greek-val"><div class="gk-label">Delta (Œî)</div><div class="gk-num '+dc+'">'+g.delta+'</div></div>'
      +'<div class="greek-val"><div class="gk-label">Gamma (Œì)</div><div class="gk-num">'+g.gamma+'</div></div>'
      +'<div class="greek-val"><div class="gk-label">Theta (Œò)</div><div class="gk-num '+tc+'">'+g.theta+'</div></div>'
      +'<div class="greek-val"><div class="gk-label">Vega (ŒΩ)</div><div class="gk-num">'+g.vega+'</div></div>'
      +'</div>'
      +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px;font-size:12px"><div class="kv">Max Loss: <b class="red">‚Çπ'+maxLoss.toFixed(2)+'</b></div><div class="kv">Leverage: <b>'+leverageRatio+'</b></div><div class="kv">Lot Cost: <b>‚Çπ'+(premium*25).toFixed(0)+'</b> <span class="muted" style="font-size:10px">(Nifty lot)</span></div></div>'
      +'<div style="margin-top:12px;padding-top:10px;border-top:1px solid #1e293b;font-size:11px;color:#94a3b8;line-height:1.6">'
      +'<b>What this means:</b><br>'
      +(type==="CE"
        ?'‚Ä¢ <b>Delta '+g.delta+'</b> ‚Äî For every ‚Çπ1 spot rises, this CE gains ~‚Çπ'+Math.abs(g.delta).toFixed(2)+'<br>'
        :'‚Ä¢ <b>Delta '+g.delta+'</b> ‚Äî For every ‚Çπ1 spot falls, this PE gains ~‚Çπ'+Math.abs(g.delta).toFixed(2)+'<br>')
      +'‚Ä¢ <b>Gamma '+g.gamma+'</b> ‚Äî Delta changes by '+g.gamma+' for each ‚Çπ1 spot move (acceleration)<br>'
      +'‚Ä¢ <b>Theta '+g.theta+'</b> ‚Äî You lose ‚Çπ'+Math.abs(g.theta).toFixed(2)+' per day to time decay<br>'
      +'‚Ä¢ <b>Vega '+g.vega+'</b> ‚Äî If IV rises 1%, premium increases by ‚Çπ'+Math.abs(g.vega).toFixed(2)+'<br>'
      +'‚Ä¢ <b>Breakeven at ‚Çπ'+breakeven.toFixed(2)+'</b> ‚Äî Spot must cross this for profit at expiry'
      +'</div></div>';
  }catch(e){out.innerHTML='<div class="card">Error: '+esc(e.message)+'</div>'}
}

function fillGreeksFromStock(){
  const stock=document.getElementById("stockList").value;
  if(!stock){showToast("‚ÑπÔ∏è Select a stock","Choose a stock from the dropdown first","#f59e0b");return}
  const q=WL_QUOTES[stock];
  if(q&&q.ltp){
    document.getElementById("gkSpot").value=Math.round(q.ltp);
    document.getElementById("gkStrike").value=Math.round(q.ltp/50)*50;
    showToast("üìà Loaded",stock+" LTP ‚Çπ"+q.ltp+" applied","#0ea5e9");
    return;
  }
  const all=[].concat(C.indices||[],C.stocks||[],C.commodities||[]);
  const found=all.find(x=>(x.name||"").toUpperCase().includes(stock.toUpperCase()));
  if(found&&found.ltp){
    document.getElementById("gkSpot").value=Math.round(found.ltp);
    document.getElementById("gkStrike").value=Math.round(found.ltp/50)*50;
    showToast("üìà Loaded",stock+" LTP ‚Çπ"+found.ltp+" applied","#0ea5e9");
  } else {
    showToast("‚ö†Ô∏è No data","LTP not available. Enter manually or refresh data.","#f59e0b");
  }
}


async function fetchData(){const b=sessionStorage.getItem("B"),t=sessionStorage.getItem("T");if(!b||!t)return;try{const r=await fetch(b+"/api/angel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"fetch_all",token:t})});const j=await r.json().catch(()=>null);if(j?.ok){if(!WARMUP_FE.firstFetch)WARMUP_FE.firstFetch=Date.now();WARMUP_FE.cycles++;C={indices:j.data?.indices?.length?j.data.indices:C.indices||[],stocks:j.data?.stocks?.length?j.data.stocks:C.stocks||[],commodities:j.data?.commodities?.length?j.data.commodities:C.commodities||[],watchlist:j.data?.watchlist||C.watchlist||[],alerts:j.data?.alerts||C.alerts||[],_meta:j.data?._meta||{}};render();checkNewAlerts()}}catch(e){console.log("fetch err:",e)}}

document.getElementById("dashboard").style.display="block";
// Start services after DOM ready
requestNotifPermission();
startWLAutoRefresh();
setTimeout(connectAlertSSE,3000);
</script>
</body>
</html>
