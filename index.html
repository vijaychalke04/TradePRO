<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Trade Genie PRO v3.1</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#050b18;color:#e2e8f0;font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh}
a{color:#60a5fa;text-decoration:none}a:hover{text-decoration:underline}
.login{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;gap:10px;background:radial-gradient(ellipse at 50% 30%,rgba(37,99,235,.08),transparent 70%)}
.login h2{font-size:28px;margin-bottom:4px}.login .sub{color:#64748b;font-size:13px;margin-bottom:12px}
input,select{padding:11px 14px;width:340px;border:none;border-radius:10px;background:#0f172a;color:#e5e7eb;outline:1px solid rgba(148,163,184,.15);font-size:14px}
input:focus,select:focus{outline:1.5px solid rgba(59,130,246,.7)}
button,.btn{padding:10px 22px;background:#2563eb;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:14px;transition:background .2s}
button:hover,.btn:hover{background:#1d4ed8}
.btn-purple{background:#7c3aed}.btn-purple:hover{background:#6d28d9}
.muted{color:#64748b}
/* TICKER ‚Äî scrolling */
.ticker-wrap{overflow:hidden;background:#0b1220;border-bottom:1px solid rgba(148,163,184,.06);white-space:nowrap;position:relative}
.ticker-inner{display:inline-flex;animation:tickerScroll 40s linear infinite}
.ticker-inner:hover{animation-play-state:paused}
.ticker-item{padding:8px 20px;display:inline-flex;gap:8px;align-items:center;font-size:12px;flex-shrink:0;border-right:1px solid rgba(148,163,184,.06)}
.ticker-item .tn{color:#94a3b8;font-weight:700}.ticker-item .tp{font-weight:800}.ticker-item .tc{font-weight:700}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.green{color:#10b981}.red{color:#ef4444}.amber{color:#f59e0b}
.top{background:#0b1220;padding:12px 20px;font-size:20px;font-weight:800;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(148,163,184,.08)}
.tabs{display:flex;gap:6px;padding:10px 14px;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(5,11,24,.9));position:sticky;top:0;z-index:20;border-bottom:1px solid rgba(148,163,184,.08);backdrop-filter:blur(12px);flex-wrap:wrap;align-items:center}
.tab{padding:8px 14px;background:#111827;border:1px solid rgba(148,163,184,.1);border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;user-select:none;white-space:nowrap;transition:all .15s}
.tab:hover{background:#1e293b}.active{background:#2563eb!important;border-color:rgba(59,130,246,.5)!important;color:white}
.toolRight{display:flex;gap:6px;align-items:center;font-size:12px;margin-left:auto}
.chk{display:flex;gap:5px;align-items:center;color:#94a3b8;padding:6px 10px;border-radius:10px;border:1px solid rgba(148,163,184,.1);background:#0f172a;cursor:pointer;font-size:11px}
.chk input[type=checkbox]{width:auto;margin:0}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;padding:14px}
.grid5{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;padding:14px}
.card{background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(11,18,32,.98));border:1px solid rgba(148,163,184,.1);padding:14px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.2);transition:border-color .3s}
.card .row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.card .title{font-size:14px;font-weight:700;color:#f1f5f9;flex:1;word-break:break-word}
.card .badges{display:flex;gap:4px;flex-wrap:wrap;flex-shrink:0}
.card .ltp{font-size:22px;font-weight:900;margin:4px 0 2px;font-family:'SF Mono',ui-monospace,monospace}
.kv{font-size:12px;color:#94a3b8;line-height:1.6;margin-top:2px}.kv b{color:#cbd5e1}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:800;letter-spacing:.05em}
.badge-buy{background:#10b981;color:#022c22}.badge-sell{background:#ef4444;color:#1c0a0a}.badge-hold{background:#475569;color:#e2e8f0}
.badge-pos{background:#059669;color:#ecfdf5}.badge-neg{background:#dc2626;color:#fef2f2}.badge-neu{background:#d97706;color:#1c1a12}.badge-na{background:#334155;color:#94a3b8}
.pill{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:800}
.pill.buy{background:#10b981;color:#022c22}.pill.sell{background:#ef4444;color:#1c0a0a}.pill.hold{background:#475569;color:#e2e8f0}
.idx-card{background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(11,18,32,.95));border:1px solid rgba(148,163,184,.08);border-radius:12px;padding:14px;transition:border-color .2s}
.idx-card:hover{border-color:rgba(148,163,184,.2)}
.idx-name{font-size:12px;font-weight:700;color:#94a3b8}.idx-ltp{font-size:20px;font-weight:900;font-family:'SF Mono',ui-monospace,monospace;margin:3px 0}
.idx-chg{font-size:12px;font-weight:700;margin:2px 0}.idx-ohlc{font-size:10px;color:#475569;margin-top:4px;line-height:1.6}.idx-ohlc span{color:#64748b}
.com-card{background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(11,18,32,.95));border:1px solid rgba(148,163,184,.08);border-radius:12px;padding:14px}
.com-icon{font-size:22px;margin-right:6px}.com-label{font-size:13px;font-weight:800;color:#f59e0b}
.com-expiry{font-size:10px;color:#64748b;margin-left:6px}.com-ltp{font-size:20px;font-weight:900;font-family:'SF Mono',ui-monospace,monospace;margin:4px 0}
.global-card{background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(11,18,32,.95));border:1px solid rgba(148,163,184,.08);border-radius:12px;padding:14px}
.global-flag{font-size:20px}.global-name{font-size:12px;color:#94a3b8;font-weight:700;margin-top:2px}.global-ltp{font-size:18px;font-weight:900;font-family:'SF Mono',ui-monospace,monospace;margin:4px 0}.global-chg{font-size:12px;font-weight:700}
.pat{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;margin-top:4px;margin-right:4px}
.pat.bullish{background:rgba(16,185,129,.12);color:#6ee7b7;border:1px solid rgba(16,185,129,.2)}
.pat.bearish{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.2)}
.pat.neutral{background:rgba(148,163,184,.08);color:#94a3b8;border:1px solid rgba(148,163,184,.1)}
.news-item{padding:14px;border-bottom:1px solid rgba(148,163,184,.06)}.news-item:hover{background:rgba(30,41,59,.3)}
.news-title{font-size:14px;font-weight:600;color:#f1f5f9;margin-bottom:4px}
.news-meta{font-size:11px;color:#64748b;display:flex;gap:8px;margin-bottom:4px}.news-desc{font-size:12px;color:#94a3b8;line-height:1.5}
.bt-warn{padding:10px;border-radius:8px;font-size:13px;line-height:1.6;margin-top:8px}
.bt-warn.neg{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#fca5a5}
.bt-warn.pos{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:#6ee7b7}
.bt-warn.amb{background:rgba(217,119,6,.06);border:1px solid rgba(217,119,6,.2);color:#fbbf24}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(148,163,184,.2);border-top-color:#60a5fa;border-radius:50%;animation:spin .5s linear infinite;vertical-align:middle;margin-left:4px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulseGood{0%,100%{box-shadow:0 0 0 rgba(16,185,129,0)}50%{box-shadow:0 0 16px rgba(16,185,129,.15);border-color:rgba(16,185,129,.5)}}
@keyframes pulseBad{0%,100%{box-shadow:0 0 0 rgba(239,68,68,0)}50%{box-shadow:0 0 16px rgba(239,68,68,.15);border-color:rgba(239,68,68,.5)}}
.pulse-good{animation:pulseGood 2s ease-in-out infinite}.pulse-bad{animation:pulseBad 2s ease-in-out infinite}
.sec{padding:14px}.sec-label{font-size:11px;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:#475569;margin-bottom:10px;padding:0 4px}
.mono{font-family:'SF Mono',ui-monospace,monospace}
.wl-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(148,163,184,.06)}.wl-row:hover{background:rgba(30,41,59,.3)}
</style>
</head>
<body>
<div id="loginScreen" class="login">
  <h2>üßû Trade Genie PRO</h2>
  <div class="sub">Institutional-Grade Personal Trading Engine v3.1</div>
  <input id="backend" placeholder="Render Backend URL" value="https://tradepro-5hpz.onrender.com">
  <input id="mpin" type="password" placeholder="Angel MPIN" autocomplete="off">
  <input id="totp" placeholder="TOTP Code" autocomplete="off">
  <button onclick="doLogin()">Login</button>
  <p id="status" class="muted" style="margin-top:4px;font-size:13px"></p>
</div>
<div id="app" style="display:none">
  <div id="tickerWrap" class="ticker-wrap"><div id="tickerInner" class="ticker-inner"></div></div>
  <div class="top"><div>üßû Trade Genie PRO</div><div id="mktStatus" class="mono" style="font-size:13px">‚Äî</div></div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('dashboard',this)">Dashboard</div>
    <div class="tab" onclick="switchTab('trade',this)">Trade Suggestions</div>
    <div class="tab" onclick="switchTab('stocks',this)">Stocks</div>
    <div class="tab" onclick="switchTab('commodities',this)">Commodities</div>
    <div class="tab" onclick="switchTab('global',this)">üåç Global</div>
    <div class="tab" onclick="switchTab('news',this)">üì∞ News</div>
    <div class="tab" onclick="switchTab('backtest',this)">Backtesting</div>
    <div class="tab" onclick="switchTab('journal',this)">Journal</div>
    <div class="toolRight">
      <label class="chk"><input type="checkbox" id="showHold" checked onchange="toggleHold()"> HOLD</label>
      <div class="tab" onclick="manualRefresh()">üîÑ Refresh</div>
      <div class="tab" onclick="doLogout()">Logout</div>
    </div>
  </div>
  <div id="dashboard"></div>
  <div id="trade" class="grid" style="display:none"></div>
  <div id="stocks" class="grid" style="display:none"></div>
  <div id="commodities" style="display:none"></div>
  <div id="global" style="display:none"></div>
  <div id="news" style="display:none"></div>
  <div id="backtest" style="display:none;padding:14px">
    <h3 style="font-size:16px;margin-bottom:12px">üìä Real EMA Crossover + Multi-Indicator Analysis</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px">
      <input id="searchStock" placeholder="Search stock..." style="flex:1;min-width:180px" onkeyup="filterStocks()">
      <select id="stockList" style="min-width:180px"></select>
      <button onclick="runBacktest()">Run Backtest</button>
      <button class="btn btn-purple" onclick="runMC()">Monte Carlo</button>
    </div>
    <div id="mcOut"></div><div id="btResult"></div>
  </div>
  <div id="journal" style="display:none;padding:14px"><div class="sec-label">Trade Journal</div><div id="journalGrid" class="grid"></div></div>
</div>
<script>
let C={indices:[],stocks:[],commodities:[],watchlist:[]},SHOW_HOLD=true,pollTimer=null,mktTimer=null,sseConn=null;
let JOURNAL=[];try{JOURNAL=JSON.parse(localStorage.getItem("TG31_JOURNAL")||"[]")}catch(e){JOURNAL=[]}
const STOCK_LIST=["ADANIENT","ADANIPORTS","APOLLOHOSP","ASIANPAINT","AXISBANK","BAJAJ-AUTO","BAJFINANCE","BAJAJFINSV","BPCL","BHARTIARTL","BRITANNIA","CIPLA","COALINDIA","DIVISLAB","DRREDDY","EICHERMOT","GRASIM","HCLTECH","HDFCBANK","HDFCLIFE","HEROMOTOCO","HINDALCO","HINDUNILVR","ICICIBANK","ITC","INDUSINDBK","INFY","JSWSTEEL","KOTAKBANK","LT","M&M","MARUTI","NESTLEIND","NTPC","ONGC","POWERGRID","RELIANCE","SBILIFE","SBIN","SUNPHARMA","TCS","TATACONSUM","TATAMOTORS","TATASTEEL","TECHM","TITAN","ULTRACEMCO","UPL","WIPRO"];
const COM_ICONS={"CRUDEOIL":"üõ¢Ô∏è","CRUDE":"üõ¢Ô∏è","NATURALGAS":"üî•","NATGAS":"üî•","GOLD":"ü™ô","GOLDM":"ü™ô","SILVER":"ü•à","SILVERM":"ü•à","COPPER":"üü§"};

/* ===== HELPERS ===== */
function esc(s){const d=document.createElement("div");d.textContent=s;return d.innerHTML}
function fN(v,d){d=d||2;const n=+v;return isFinite(n)?n.toLocaleString("en-IN",{minimumFractionDigits:d,maximumFractionDigits:d}):"‚Äî"}
function fP(v){const n=+v;return isFinite(n)?n.toFixed(2):"‚Äî"}
function fmt(v){if(v==null||v==="")return"‚Äî";if(typeof v==="object"){if(v.suggested)return String(v.suggested);if(v.strike)return v.strike+" "+(v.optionType||"");return"‚Äî"}return String(v)}
function sigBadge(s){s=(s||"HOLD").toUpperCase();return s==="BUY"?'<span class="badge badge-buy">BUY</span>':s==="SELL"?'<span class="badge badge-sell">SELL</span>':'<span class="badge badge-hold">HOLD</span>'}
function edgeBadge(e){e=(e||"NA").toUpperCase();if(e.includes("POS"))return'<span class="badge badge-pos">POSITIVE</span>';if(e.includes("NEG"))return'<span class="badge badge-neg">NEGATIVE</span>';if(e.includes("NEU"))return'<span class="badge badge-neu">NEUTRAL</span>';return'<span class="badge badge-na">'+e+'</span>'}
function chgClass(v){return(+v||0)>=0?"green":"red"}
function arrow(v){return(+v||0)>=0?"‚ñ≤":"‚ñº"}
function patHTML(pats){if(!pats||!pats.length)return"";return pats.map(p=>'<span class="pat '+(p.sentiment==="Bullish"?"bullish":p.sentiment==="Bearish"?"bearish":"neutral")+'">'+esc(p.name)+'</span>').join("")}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORMAT SYMBOL ‚Äî adds spaces for readability
// "NATURALGAS20FEB26315CE" ‚Üí "NATURALGAS 20FEB26 315 CE"
// "GOLDM26FEB26131700PE" ‚Üí "GOLDM 26FEB26 1317 PE"
// Also handles "SBIN-EQ" ‚Üí "SBIN"
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtSym(n){
  n=String(n||"").replace(/-EQ$/i,"").trim();
  // Match: NAME + DATE(DDMMMYY) + STRIKE + CE/PE
  const m=n.match(/^([A-Z]+?)(\d{1,2}[A-Z]{3}\d{2})(\d+)(CE|PE)$/i);
  if(m)return m[1]+" "+m[2]+" "+m[3]+" "+m[4];
  // Match futures: NAME + DATE + FUT
  const m2=n.match(/^([A-Z]+?)(\d{1,2}[A-Z]{3}\d{2,4})(FUT)$/i);
  if(m2)return m2[1]+" "+m2[2]+" "+m2[3];
  return n;
}
function prettySym(n){return fmtSym(n).replace(/Nifty Fin Servi ce/i,"FINNIFTY").replace(/Nifty 50/i,"NIFTY 50").replace(/Nifty Bank/i,"BANKNIFTY").replace(/India VIX/i,"INDIA VIX")}
function comIcon(label){for(const k of Object.keys(COM_ICONS)){if(String(label||"").toUpperCase().includes(k))return COM_ICONS[k]}return"üìä"}

/* ===== MARKET STATUS (IST) ===== */
function getIST(){const n=new Date();return new Date(n.getTime()+n.getTimezoneOffset()*60000+5.5*3600000)}
function updateMktStatus(){
  const ist=getIST(),d=ist.getDay(),m=ist.getHours()*60+ist.getMinutes(),el=document.getElementById("mktStatus");if(!el)return;
  if(d===0||d===6){el.innerHTML='üî¥ <span class="red">WEEKEND CLOSED</span>';return}
  // Equity: 9:15-15:30, MCX: 9:00-23:30
  if(m>=555&&m<930)el.innerHTML='üü¢ <span class="green">EQUITY LIVE</span> ¬∑ <span class="green">MCX LIVE</span>';
  else if(m>=930&&m<935)el.innerHTML='üü° <span class="amber">EQUITY CLOSING</span> ¬∑ <span class="green">MCX LIVE</span>';
  else if(m>=935&&m<1410)el.innerHTML='üî¥ <span class="red">EQUITY CLOSED</span> ¬∑ <span class="green">MCX LIVE</span>';
  else if(m>=540&&m<555)el.innerHTML='üü° <span class="amber">PRE-OPEN</span>';
  else el.innerHTML='üî¥ <span class="red">MARKET CLOSED</span>';
}
function isEquityHours(){const ist=getIST(),d=ist.getDay(),m=ist.getHours()*60+ist.getMinutes();return d>0&&d<6&&m>=555&&m<935}
function isMcxHours(){const ist=getIST(),d=ist.getDay(),m=ist.getHours()*60+ist.getMinutes();return d>0&&d<6&&m>=540&&m<1410}
function isAnyMarketOpen(){return isEquityHours()||isMcxHours()}

/* ===== TICKER ‚Äî SCROLLING + LIVE ===== */
let tickerData=[];
function renderTicker(){
  const el=document.getElementById("tickerInner");if(!el)return;
  const all=[].concat(C.indices||[]);
  if(!all.length&&!tickerData.length){el.innerHTML="";return}
  if(all.length)tickerData=all;
  const items=tickerData.map(x=>{const c=chgClass(x.changePct);return'<div class="ticker-item" data-token="'+esc(String(x.token||""))+'"><span class="tn">'+esc(prettySym(x.name))+'</span><span class="tp '+c+'" data-field="ltp">'+fP(x.ltp)+'</span><span class="tc '+c+'" data-field="chg">'+arrow(x.changePct)+fP(Math.abs(x.change||0))+' ('+fP(Math.abs(x.changePct||0))+'%)</span></div>'});
  // Duplicate for seamless scroll
  el.innerHTML=items.join("")+items.join("");
}
function updateTickerPrice(token,ltp,change,changePct){
  document.querySelectorAll('.ticker-item[data-token="'+token+'"]').forEach(el=>{
    const pEl=el.querySelector('[data-field="ltp"]'),cEl=el.querySelector('[data-field="chg"]');
    const c=chgClass(changePct);
    if(pEl){pEl.textContent=fP(ltp);pEl.className="tp "+c}
    if(cEl){cEl.textContent=arrow(changePct)+fP(Math.abs(change||0))+" ("+fP(Math.abs(changePct||0))+"%)";cEl.className="tc "+c}
  });
}

/* ===== LOGIN ===== */
async function doLogin(){
  const backend=document.getElementById("backend").value.trim().replace(/\/+$/,""),mpin=document.getElementById("mpin").value,totp=document.getElementById("totp").value,st=document.getElementById("status");
  st.innerHTML='Logging in...<span class="spinner"></span>';
  try{
    const r=await fetch(backend+"/api/angel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"login",mpin,totp})});
    const j=await r.json().catch(()=>null);
    if(j?.ok){sessionStorage.setItem("B",backend);sessionStorage.setItem("T",j.token);document.getElementById("loginScreen").style.display="none";document.getElementById("app").style.display="block";updateMktStatus();startPolling();connectSSE();await fetchData();fetchGlobal();fetchNewsData();st.innerText=""}
    else st.innerText="Failed: "+(j?.error||"Unknown")
  }catch(e){st.innerText="Error: "+e.message}
}
async function doLogout(){
  try{const b=sessionStorage.getItem("B"),t=sessionStorage.getItem("T");if(b)await fetch(b+"/api/angel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"logout",token:t})}).catch(()=>{})}catch(e){}
  stopPolling();if(sseConn){sseConn.close();sseConn=null}
  sessionStorage.clear();document.getElementById("app").style.display="none";document.getElementById("loginScreen").style.display="flex"
}
function startPolling(){stopPolling();const ms=isAnyMarketOpen()?5000:30000;pollTimer=setInterval(fetchData,ms);mktTimer=setInterval(()=>{updateMktStatus();const ms2=isAnyMarketOpen()?5000:30000;clearInterval(pollTimer);pollTimer=setInterval(fetchData,ms2)},30000)}
function stopPolling(){if(pollTimer)clearInterval(pollTimer);if(mktTimer)clearInterval(mktTimer)}
function manualRefresh(){fetchData();fetchGlobal();fetchNewsData()}

/* ===== SSE ===== */
function connectSSE(){
  const b=sessionStorage.getItem("B");if(!b)return;
  try{sseConn=new EventSource(b+"/api/stream");
    sseConn.addEventListener("tick",e=>{try{const d=JSON.parse(e.data);if(d.token&&isFinite(d.ltp))handleTick(d)}catch(e){}});
    sseConn.onerror=()=>{};
  }catch(e){}
}
function handleTick(tick){
  const all=[].concat(C.indices||[],C.stocks||[],C.commodities||[]);
  const item=all.find(x=>String(x.token)===String(tick.token));
  if(item){
    item.ltp=tick.ltp;if(tick.open)item.open=tick.open;if(tick.high)item.high=tick.high;if(tick.low)item.low=tick.low;
    if(tick.close)item.close=tick.close;
    const cl=item.close||tick.close||item.ltp;item.change=+(tick.ltp-cl).toFixed(2);item.changePct=cl?+((tick.ltp-cl)/cl*100).toFixed(2):0;
    // Update ticker strip in-place (no full re-render)
    updateTickerPrice(String(tick.token),tick.ltp,item.change,item.changePct);
    // Update visible card
    const el=document.querySelector('[data-token="'+tick.token+'"] .ltp');if(el)el.textContent="‚Çπ "+fP(tick.ltp);
  }
}

/* ===== TAB SWITCHING ===== */
function switchTab(id,el){
  document.querySelectorAll(".tabs .tab").forEach(x=>x.classList.remove("active"));if(el)el.classList.add("active");
  ["dashboard","trade","stocks","commodities","global","news","backtest","journal"].forEach(t=>{const n=document.getElementById(t);if(n)n.style.display="none"});
  const s=document.getElementById(id);if(!s)return;s.style.display=(id==="trade"||id==="stocks")?"grid":"block";
  if(id==="global")fetchGlobal();if(id==="news")fetchNewsData();
}
function toggleHold(){SHOW_HOLD=!!document.getElementById("showHold")?.checked;render()}

/* ===== CARD BUILDER ===== */
function buildCard(item,showPatterns){
  const nm=item.name||"‚Äî",ltp=item.ltp,eng=item.engine||{},sig=(eng.signal||"HOLD").toUpperCase();
  if(!SHOW_HOLD&&sig==="HOLD")return"";
  const edge=(eng.edge||"NA").toUpperCase();
  const pulse=sig==="BUY"?"pulse-good":sig==="SELL"?"pulse-bad":"";
  let opt=fmt(eng.optionSuggestion);
  const tgt=eng.projectedTarget,sl=eng.stopLoss;
  let patsH="";if(showPatterns&&eng.patterns?.length)patsH='<div style="margin-top:4px">'+patHTML(eng.patterns)+'</div>';
  return'<div class="card '+pulse+'" data-token="'+esc(String(item.token||""))+'"><div class="row"><div class="title">'+esc(prettySym(nm))+'</div><div class="badges">'+sigBadge(sig)+edgeBadge(edge)+'</div></div>'+(isFinite(+ltp)?'<div class="ltp">‚Çπ '+fP(ltp)+'</div>':'')+'<div class="kv">Mode: <b>'+fmt(eng.mode)+'</b> &nbsp; Trade: <b>'+esc(prettySym(fmt(eng.trade)))+'</b></div><div class="kv">Option: <b>'+esc(fmtSym(opt))+'</b></div><div class="kv">Target: <b>'+(tgt!=null?fP(tgt):"‚Äî")+'</b> | SL: <b>'+(sl!=null?fP(sl):"‚Äî")+'</b></div>'+(eng.reason?'<div class="kv muted" style="font-size:11px;font-style:italic">'+esc(String(eng.reason))+'</div>':'')+patsH+'</div>'
}

/* ===== JOURNAL (FIXED: stronger dedup) ===== */
const _jSeen={};
function logJ(item,sig,trade,opt,tgt,sl){
  if(sig==="HOLD")return;
  // Dedup by: token + signal + option ‚Äî 5 minute cooldown
  const key=String(item.token||item.name)+"_"+sig+"_"+String(opt||"");
  const now=Date.now();
  if(_jSeen[key]&&now-_jSeen[key]<300000)return; // 5 min cooldown
  _jSeen[key]=now;
  JOURNAL.push({time:getIST().toLocaleString("en-IN"),symbol:item.name||"?",signal:sig,trade:fmtSym(trade),option:fmtSym(opt),ltp:item.ltp,target:tgt,sl});
  if(JOURNAL.length>80)JOURNAL=JOURNAL.slice(-50);
  try{localStorage.setItem("TG31_JOURNAL",JSON.stringify(JOURNAL))}catch(e){}
}

/* ===== RENDER ===== */
function render(){
  const dashEl=document.getElementById("dashboard"),tradeEl=document.getElementById("trade"),stocksEl=document.getElementById("stocks"),comEl=document.getElementById("commodities");
  renderTicker();
  /* DASHBOARD */
  if(dashEl){let h='<div class="sec"><div class="sec-label">üìà Indices</div><div class="grid5">';
    (C.indices||[]).forEach(x=>{const c=chgClass(x.changePct);h+='<div class="idx-card" data-token="'+esc(String(x.token||""))+'"><div class="idx-name">'+esc(prettySym(x.name))+'</div><div class="idx-ltp '+c+'">'+fN(x.ltp)+'</div><div class="idx-chg '+c+'">'+arrow(x.changePct)+' '+fP(Math.abs(x.change||0))+' ('+fP(Math.abs(x.changePct||0))+'%)</div><div class="idx-ohlc"><span>O:</span>'+fN(x.open)+' <span>H:</span>'+fN(x.high)+' <span>L:</span>'+fN(x.low)+' <span>C:</span>'+fN(x.close)+'</div></div>'});
    h+='</div></div>';
    // Ready Trades
    const ready=[].concat(C.indices||[],C.stocks||[],C.commodities||[]).filter(x=>{const s=(x.engine?.signal||"").toUpperCase();return s==="BUY"||s==="SELL"}).slice(0,8);
    h+='<div class="sec"><div class="sec-label">üéØ Ready Trades</div><div class="grid">';
    if(!ready.length)h+='<div class="card"><div class="muted">No actionable trades. Engine analyzing...</div></div>';
    else ready.forEach(x=>{h+=buildCard(x,true);const e=x.engine||{};logJ(x,(e.signal||"").toUpperCase(),fmt(e.trade),fmt(e.optionSuggestion),e.projectedTarget,e.stopLoss)});
    h+='</div></div>';
    // Next Day Watchlist
    h+='<div class="sec"><div class="sec-label">üìã Next Day Watchlist</div>';
    const wl=C.watchlist||[];
    if(!wl.length)h+='<div class="card"><div class="muted">Watchlist builds from active signals. Check after market hours.</div></div>';
    else{h+='<div class="card" style="padding:0;overflow:hidden">';wl.forEach(w=>{const c=chgClass(w.changePct);h+='<div class="wl-row"><div><b>'+esc(prettySym(w.name))+'</b> <span class="'+c+'">'+fP(w.changePct)+'%</span></div><div>'+sigBadge(w.signal)+'</div><div class="kv" style="margin:0">'+esc(fmtSym(w.option||w.trade||""))+'</div><div class="kv" style="margin:0">T: '+fP(w.target)+' | SL: '+fP(w.sl)+'</div></div>'});h+='</div>'}
    h+='</div>';dashEl.innerHTML=h}
  /* TRADE SUGGESTIONS */
  if(tradeEl){let h="";[].concat(C.indices||[],C.stocks||[],C.commodities||[]).forEach(x=>{const c=buildCard(x,true);if(c){h+=c;const e=x.engine||{};if((e.signal||"HOLD")!=="HOLD")logJ(x,e.signal.toUpperCase(),fmt(e.trade),fmt(e.optionSuggestion),e.projectedTarget,e.stopLoss)}});tradeEl.innerHTML=h||'<div class="card muted">Waiting...</div>'}
  /* STOCKS */
  if(stocksEl){let h="";(C.stocks||[]).forEach(x=>{const c=buildCard(x);if(c)h+=c});stocksEl.innerHTML=h||'<div class="card muted">No stocks</div>'}
  /* COMMODITIES ‚Äî price cards + signals */
  if(comEl){let h='<div class="sec"><div class="sec-label">üõ¢Ô∏è Commodity Futures Prices</div><div class="grid5">';
    const coms=C.commodities||[];
    if(!coms.length)h+='<div class="card muted">Resolving MCX futures contracts...</div>';
    else coms.forEach(x=>{const c=chgClass(x.changePct||x.change);const nm=prettySym(x.name);const icon=comIcon(x.name);h+='<div class="com-card"><div style="display:flex;align-items:center;gap:6px"><span class="com-icon">'+icon+'</span><span class="com-label">'+esc(nm)+'</span></div><div class="com-ltp '+c+'">‚Çπ '+fN(x.ltp)+'</div><div class="idx-chg '+c+'">'+arrow(x.changePct||x.change)+' '+fP(Math.abs(x.change||0))+' ('+fP(Math.abs(x.changePct||0))+'%)</div><div class="idx-ohlc"><span>O:</span>'+fN(x.open)+' <span>H:</span>'+fN(x.high)+' <span>L:</span>'+fN(x.low)+' <span>C:</span>'+fN(x.close)+'</div></div>'});
    h+='</div></div>';
    h+='<div class="sec"><div class="sec-label">üìä Commodity Signals</div><div class="grid">';
    coms.forEach(x=>{const c=buildCard(x);if(c)h+=c});
    h+='</div></div>';comEl.innerHTML=h}
  const sel=document.getElementById("stockList");if(sel&&!sel.options.length)STOCK_LIST.forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n;sel.appendChild(o)});
  renderJournal();
}
function renderJournal(){const g=document.getElementById("journalGrid");if(!g)return;const e=JOURNAL.slice(-30).reverse();if(!e.length){g.innerHTML='<div class="card muted">No entries yet</div>';return}g.innerHTML=e.map(j=>'<div class="card"><div class="kv"><b>'+esc(j.time||"")+'</b> ‚Äî <b>'+esc(prettySym(j.symbol))+'</b></div><div class="kv">'+sigBadge(j.signal)+' Trade: <b>'+esc(j.trade||"")+'</b></div><div class="kv">Option: <b>'+esc(j.option||"‚Äî")+'</b> LTP: <b>‚Çπ'+fP(j.ltp)+'</b></div><div class="kv">Target: <b>'+fP(j.target)+'</b> | SL: <b>'+fP(j.sl)+'</b></div></div>').join("")}

/* ===== GLOBAL ===== */
async function fetchGlobal(){
  const el=document.getElementById("global");if(!el)return;const b=sessionStorage.getItem("B");if(!b)return;
  el.innerHTML='<div class="sec"><div class="sec-label">üåç Global Indices</div><div class="grid5"><div class="card">Loading...<span class="spinner"></span></div></div></div>';
  try{const r=await fetch(b+"/api/global-indices");const j=await r.json();
    if(!j?.ok||!j.data?.length){el.innerHTML='<div class="sec"><div class="card muted">Could not fetch global data</div></div>';return}
    let h='<div class="sec"><div class="sec-label">üåç Global Indices</div><div class="grid5">';
    j.data.forEach(g=>{if(g.error){h+='<div class="global-card"><div class="global-flag">'+esc(g.flag||"")+'</div><div class="global-name">'+esc(g.name)+'</div><div class="muted">Unavailable</div></div>';return}
      const c=chgClass(g.changePct);h+='<div class="global-card"><div class="global-flag">'+esc(g.flag||"üåê")+'</div><div class="global-name">'+esc(g.name)+' <span class="muted">('+esc(g.currency||"")+')</span></div><div class="global-ltp '+c+'">'+fN(g.ltp)+'</div><div class="global-chg '+c+'">'+arrow(g.changePct)+' '+fP(Math.abs(g.change||0))+' ('+fP(Math.abs(g.changePct||0))+'%)</div></div>'});
    h+='</div></div>';el.innerHTML=h;
  }catch(e){el.innerHTML='<div class="sec"><div class="card muted">Failed to load</div></div>'}
}

/* ===== NEWS ===== */
async function fetchNewsData(){
  const el=document.getElementById("news");if(!el)return;const b=sessionStorage.getItem("B");if(!b)return;
  el.innerHTML='<div class="sec"><div class="sec-label">üì∞ Market News</div><div class="card">Loading...<span class="spinner"></span></div></div>';
  try{const r=await fetch(b+"/api/news");const j=await r.json();
    if(!j?.ok||!j.data?.length){el.innerHTML='<div class="sec"><div class="card muted">No news available</div></div>';return}
    let h='<div class="sec"><div class="sec-label">üì∞ Market News <span class="muted" style="font-weight:400;letter-spacing:0">'+j.data.length+' articles</span></div><div class="card" style="padding:0;overflow:hidden">';
    j.data.slice(0,25).forEach(n=>{const ago=n.pubDate?timeAgo(new Date(n.pubDate)):"";h+='<div class="news-item"><div class="news-title"><a href="'+esc(n.link)+'" target="_blank">'+esc(n.title)+'</a></div><div class="news-meta"><span class="badge badge-na">'+esc(n.source)+'</span><span>'+esc(ago)+'</span></div>'+(n.description?'<div class="news-desc">'+esc(n.description)+'</div>':'')+'</div>'});
    h+='</div></div>';el.innerHTML=h;
  }catch(e){el.innerHTML='<div class="sec"><div class="card muted">Failed</div></div>'}
}
function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return"Just now";if(s<3600)return Math.floor(s/60)+" min ago";if(s<86400)return Math.floor(s/3600)+" hr ago";return Math.floor(s/86400)+" days ago"}

/* ===== BACKTEST ===== */
function filterStocks(){const t=document.getElementById("searchStock").value.toLowerCase();[...document.getElementById("stockList").options].forEach(o=>o.style.display=o.value.toLowerCase().includes(t)?"":"none")}
async function runBacktest(){
  const stock=document.getElementById("stockList").value,out=document.getElementById("btResult");
  out.innerHTML='<div class="card">Analyzing '+esc(stock)+'...<span class="spinner"></span></div>';
  try{const b=sessionStorage.getItem("B"),jwt=sessionStorage.getItem("T");if(!b||!jwt){out.innerHTML='<div class="card muted">Login first</div>';return}
    const r=await fetch(b+"/api/backtest/stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:stock,exchange:"NSE",jwtToken:jwt})});
    const j=await r.json();if(!j?.ok){out.innerHTML='<div class="card">'+esc(j?.error||"Failed")+'</div>';return}
    const w=j.winRate,sig=j.signal,conf=j.confidence||"‚Äî",ltp=j.ltp,sc=sig==="BUY"?"green":sig==="SELL"?"red":"";
    let sug="",msg="";
    if(sig==="BUY"&&w>=55){sug="BUY "+stock;msg="Bullish EMA crossover confirmed"}else if(sig==="SELL"&&w>=55){sug="SELL "+stock;msg="Bearish EMA crossover confirmed"}else if(sig!=="HOLD"){sug="WAIT ‚Äî Low confidence";msg="Signal present but weak win rate"}else{sug="NO TRADE";msg="No active crossover"}
    let tgt="‚Äî",sl="‚Äî";if(sig==="BUY"&&isFinite(ltp)){tgt=fP(ltp*1.012);sl=fP(ltp*.993)}else if(sig==="SELL"&&isFinite(ltp)){tgt=fP(ltp*.988);sl=fP(ltp*1.007)}
    let patStr="";if(j.patterns?.length)patStr='<div style="margin-top:8px">'+patHTML(j.patterns)+'</div>';
    let extras="";if(j.bollinger)extras+='<div class="kv">Bollinger: <b>'+fP(j.bollinger.lower)+'</b> ‚Äî <b>'+fP(j.bollinger.middle)+'</b> ‚Äî <b>'+fP(j.bollinger.upper)+'</b></div>';
    if(j.macd)extras+='<div class="kv">MACD: <b>'+fP(j.macd.line)+'</b> Signal: <b>'+fP(j.macd.signal)+'</b> Hist: <b class="'+(j.macd.histogram>=0?"green":"red")+'">'+fP(j.macd.histogram)+'</b></div>';
    if(j.supertrend)extras+='<div class="kv">Supertrend: <b>'+fP(j.supertrend.value)+'</b> <span class="badge '+(j.supertrend.trend==="BULLISH"?"badge-buy":"badge-sell")+'">'+j.supertrend.trend+'</span></div>';
    const pulse=w>=60?"pulse-good":w<=45?"pulse-bad":"";
    out.innerHTML='<div class="card '+pulse+'"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:20px;font-weight:800">'+esc(stock)+'</div><div class="muted" style="font-size:11px">'+esc(j.strategy||"EMA 9/21")+' ¬∑ '+j.candleCount+' candles</div></div><span class="pill '+(sig==="BUY"?"buy":sig==="SELL"?"sell":"hold")+'">'+sig+'</span></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px"><div class="kv">Win Rate<br><b style="font-size:18px" class="'+sc+'">'+w+'%</b></div><div class="kv">Trades<br><b style="font-size:18px">'+j.totalTrades+'</b></div><div class="kv">Avg P&L<br><b style="font-size:18px" class="'+(j.avgPnl>=0?"green":"red")+'">‚Çπ'+fP(j.avgPnl)+'</b></div><div class="kv">RSI(14)<br><b style="font-size:18px">'+fP(j.rsi)+'</b></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px"><div class="kv">EMA Fast: <b>'+fP(j.emaFast)+'</b> / Slow: <b>'+fP(j.emaSlow)+'</b></div><div class="kv">Confidence: <b>'+esc(conf)+'</b></div></div>'+extras+patStr+'<div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(148,163,184,.1)"><div class="sec-label" style="margin-bottom:4px">RECOMMENDATION</div><div style="font-size:18px;font-weight:900" class="'+sc+'">'+esc(sug)+'</div><div class="kv">LTP: <b>‚Çπ'+fP(ltp)+'</b> ¬∑ Target: <b>'+tgt+'</b> ¬∑ SL: <b>'+sl+'</b></div><div class="muted" style="font-size:11px;margin-top:4px">'+esc(msg)+'</div></div></div>';
  }catch(e){out.innerHTML='<div class="card">Error: '+esc(e.message)+'</div>'}
}

// ‚ïê‚ïê‚ïê MONTE CARLO ‚Äî FIXED: runs on SELECTED stock, not hardcoded index ‚ïê‚ïê‚ïê
async function runMC(){
  const stock=document.getElementById("stockList").value,out=document.getElementById("mcOut");
  out.innerHTML='Running Monte Carlo on <b>'+esc(stock)+'</b>...<span class="spinner"></span>';
  try{const b=sessionStorage.getItem("B"),jwt=sessionStorage.getItem("T");if(!b||!jwt){out.innerHTML='<div class="bt-warn neg">Login first</div>';return}
    const r=await fetch(b+"/api/backtest/montecarlo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jwtToken:jwt,symbol:stock,exchange:"NSE",days:20,paths:1000})});
    const j=await r.json();if(!j?.ok){out.innerHTML='<div class="bt-warn neg">MC failed: '+esc(j?.error||"Error")+'</div>';return}
    const s=j.stats,up=s.winUp0_5??0;const label=up>=55?"POSITIVE":up>=50?"NEUTRAL":"NEGATIVE";
    let warn="";if(up<50)warn='<div class="bt-warn neg">‚ö†Ô∏è <b>Statistical edge is NEGATIVE</b> for '+esc(stock)+'. Probability of 0.5% gain: '+up+'%. Avoid trading. Wait for positive edge.</div>';
    else if(up<55)warn='<div class="bt-warn amb">‚ö° Marginal edge for '+esc(stock)+'. Consider waiting for stronger conviction.</div>';
    else warn='<div class="bt-warn pos">‚úÖ <b>Positive edge detected</b> for '+esc(stock)+'. Conditions favor directional trades with risk management.</div>';
    out.innerHTML='<div class="card"><div class="kv" style="font-size:14px">Monte Carlo ‚Äî <b>'+esc(stock)+'</b>: <span class="pill '+(label==="POSITIVE"?"buy":label==="NEGATIVE"?"sell":"hold")+'">'+label+'</span></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px"><div class="kv">Win‚â•0.5%<br><b style="font-size:16px">'+up+'%</b></div><div class="kv">P10<br><b>‚Çπ'+fN(s.p10)+'</b></div><div class="kv">P50<br><b>‚Çπ'+fN(s.p50)+'</b></div><div class="kv">P90<br><b>‚Çπ'+fN(s.p90)+'</b></div></div>'+warn+'</div>';
  }catch(e){out.innerHTML='<div class="bt-warn neg">Error: '+esc(e.message)+'</div>'}
}

/* ===== DATA FETCH ===== */
async function fetchData(){
  const b=sessionStorage.getItem("B"),t=sessionStorage.getItem("T");if(!b||!t)return;
  try{const r=await fetch(b+"/api/angel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"fetch_all",token:t})});
    const j=await r.json().catch(()=>null);
    if(j?.ok){C={indices:j.data?.indices?.length?j.data.indices:C.indices||[],stocks:j.data?.stocks?.length?j.data.stocks:C.stocks||[],commodities:j.data?.commodities?.length?j.data.commodities:C.commodities||[],watchlist:j.data?.watchlist||C.watchlist||[]};render()}}catch(e){console.log("fetch err:",e)}
}

document.getElementById("dashboard").style.display="block";
</script>
</body>
</html>
